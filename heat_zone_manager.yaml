####################################################################################################
##### Floor Heating Valve Manager Blueprint by Chester929                                     #####
##### Repository: https://github.com/Chester929/ha_custom_heat_zone_manager                   #####
##### Blueprint for managing floor heating valves with MAIN thermostat                        #####
####################################################################################################
---
blueprint:
  name: Floor Heating Valve Manager
  description: >
    # Floor Heating Valve Manager - Complete Zone Control


    **Version**: v1.0.0


    This blueprint manages floor heating valves alongside a MAIN thermostat that controls HVAC water heating.
    It dynamically adjusts valve states and the MAIN thermostat target temperature based on individual zone demands.


    **Key Features:**

    - Manages multiple heating zones (rooms) with individual thermostats/valves

    - Ensures at least one valve is ALWAYS open (critical for water pump operation)

    - Dynamically calculates MAIN thermostat target temperature based on zone demands

    - Supports manual override for temperature sensors and valve entities

    - Configurable temperature thresholds and calculation methods

    - Supports both heating and cooling modes (inverse logic)


    **Use Case:**

    Your HVAC unit heats water based on outdoor and indoor temperature sensors. Individual rooms have
    thermostats that control valves. This blueprint coordinates valve states and MAIN thermostat temperature
    to efficiently heat zones while preventing all valves from closing simultaneously.


    **Documentation:**

    For detailed setup and usage instructions, visit the [GitHub repository](https://github.com/Chester929/ha_custom_heat_zone_manager).

  source_url: https://github.com/Chester929/ha_custom_heat_zone_manager/blob/main/heat_zone_manager.yaml
  domain: automation
  homeassistant:
    min_version: 2024.1.0

  input:
    # MAIN Thermostat Configuration
    main_thermostat:
      name: MAIN Thermostat (REQUIRED)
      description: >
        The primary climate entity that controls your HVAC water heating system.
        This thermostat will have its target temperature automatically adjusted based on zone demands.
      selector:
        entity:
          domain: climate
          multiple: false

    main_temp_sensor:
      name: MAIN Temperature Sensor (Optional Override)
      description: >
        Optional temperature sensor for the MAIN thermostat location (e.g., corridor).
        If provided, the blueprint will use this to calculate smarter MAIN target temperatures
        that compensate for the difference between corridor and zone temperatures.
        This improves heating effectiveness when the MAIN sensor location differs from zones.
      default: []
      selector:
        entity:
          domain: sensor
          device_class: temperature
          multiple: false

    # ============================================================================
    # ZONES GROUP 1 (Zones 1-5) - COLLAPSIBLE
    # ============================================================================

    zones_group_1:
      name: "ðŸ  ZONES GROUP 1 (Zones 1-5)"
      icon: mdi:home-thermometer
      description: Configure heating zones 1 through 5. Each zone requires climate entity, physical valve, and virtual switch.
      collapsed: true
      input:
        # Zone 1 Configuration
        zone1_climate:
          name: Zone 1 - Climate Entity
          description: Climate entity for the first heating zone (e.g., bedroom, bathroom)
          default: []
          selector:
            entity:
              domain: climate
              multiple: false

        zone1_temp_sensor:
          name: Zone 1 - Temperature Sensor (Optional Override)
          description: Optional temperature sensor to override the climate entity's built-in sensor
          default: []
          selector:
            entity:
              domain: sensor
              device_class: temperature
              multiple: false

        zone1_valve:
          name: Zone 1 - Physical Valve Entity (REQUIRED if zone configured)
          description: >
            Physical valve switch that controls the actual heating valve.
            REQUIRED when zone is configured - must be specified along with Virtual Switch.
            The blueprint controls this physical valve directly for coordinated multi-zone heating.
          default: []
          selector:
            entity:
              multiple: false

        zone1_virtual_switch:
          name: Zone 1 - Virtual Switch (REQUIRED if zone configured)
          description: >
            Virtual/helper switch (input_boolean or switch helper) controlled by the Generic Thermostat.
            REQUIRED when zone is configured - must be specified along with Physical Valve Entity.
            Configure your Generic Thermostat to control this virtual switch instead of the physical valve.
            The blueprint monitors this switch to understand what the climate entity wants.
          default: []
          selector:
            entity:
              domain: 
                - switch
                - input_boolean
              multiple: false

        # Zone 2 Configuration
        zone2_climate:
          name: Zone 2 - Climate Entity
          description: Climate entity for the second heating zone
          default: []
          selector:
            entity:
              domain: climate
              multiple: false

        zone2_temp_sensor:
          name: Zone 2 - Temperature Sensor (Optional Override)
          description: Optional temperature sensor to override the climate entity's built-in sensor
          default: []
          selector:
            entity:
              domain: sensor
              device_class: temperature
              multiple: false

        zone2_valve:
          name: Zone 2 - Physical Valve Entity (REQUIRED if zone configured)
          description: >
            Physical valve switch that controls the actual heating valve.
            REQUIRED when zone is configured - must be specified along with Virtual Switch.
            The blueprint controls this physical valve directly for coordinated multi-zone heating.
          default: []
          selector:
            entity:
              multiple: false

        zone2_virtual_switch:
          name: Zone 2 - Virtual Switch (REQUIRED if zone configured)
          description: >
            Virtual/helper switch (input_boolean or switch helper) controlled by the Generic Thermostat.
            REQUIRED when zone is configured - must be specified along with Physical Valve Entity.
            Configure your Generic Thermostat to control this virtual switch instead of the physical valve.
            The blueprint monitors this switch to understand what the climate entity wants.
          default: []
          selector:
            entity:
              domain: 
                - switch
                - input_boolean
              multiple: false

        # Zone 3 Configuration
        zone3_climate:
          name: Zone 3 - Climate Entity
          description: Climate entity for the third heating zone
          default: []
          selector:
            entity:
              domain: climate
              multiple: false

        zone3_temp_sensor:
          name: Zone 3 - Temperature Sensor (Optional Override)
          description: Optional temperature sensor to override the climate entity's built-in sensor
          default: []
          selector:
            entity:
              domain: sensor
              device_class: temperature
              multiple: false

        zone3_valve:
          name: Zone 3 - Physical Valve Entity (REQUIRED if zone configured)
          description: >
            Physical valve switch that controls the actual heating valve.
            REQUIRED when zone is configured - must be specified along with Virtual Switch.
            The blueprint controls this physical valve directly for coordinated multi-zone heating.
          default: []
          selector:
            entity:
              multiple: false

        zone3_virtual_switch:
          name: Zone 3 - Virtual Switch (REQUIRED if zone configured)
          description: >
            Virtual/helper switch (input_boolean or switch helper) controlled by the Generic Thermostat.
            REQUIRED when zone is configured - must be specified along with Physical Valve Entity.
            Configure your Generic Thermostat to control this virtual switch instead of the physical valve.
            The blueprint monitors this switch to understand what the climate entity wants.
          default: []
          selector:
            entity:
              domain: 
                - switch
                - input_boolean
              multiple: false

        # Zone 4 Configuration
        zone4_climate:
          name: Zone 4 - Climate Entity
          description: Climate entity for the fourth heating zone
          default: []
          selector:
            entity:
              domain: climate
              multiple: false

        zone4_temp_sensor:
          name: Zone 4 - Temperature Sensor (Optional Override)
          description: Optional temperature sensor to override the climate entity's built-in sensor
          default: []
          selector:
            entity:
              domain: sensor
              device_class: temperature
              multiple: false

        zone4_valve:
          name: Zone 4 - Physical Valve Entity (REQUIRED if zone configured)
          description: >
            Physical valve switch that controls the actual heating valve.
            REQUIRED when zone is configured - must be specified along with Virtual Switch.
            The blueprint controls this physical valve directly for coordinated multi-zone heating.
          default: []
          selector:
            entity:
              multiple: false

        zone4_virtual_switch:
          name: Zone 4 - Virtual Switch (REQUIRED if zone configured)
          description: >
            Virtual/helper switch (input_boolean or switch helper) controlled by the Generic Thermostat.
            REQUIRED when zone is configured - must be specified along with Physical Valve Entity.
            Configure your Generic Thermostat to control this virtual switch instead of the physical valve.
            The blueprint monitors this switch to understand what the climate entity wants.
          default: []
          selector:
            entity:
              domain: 
                - switch
                - input_boolean
              multiple: false

        # Zone 5 Configuration
        zone5_climate:
          name: Zone 5 - Climate Entity
          description: Climate entity for the fifth heating zone
          default: []
          selector:
            entity:
              domain: climate
              multiple: false

        zone5_temp_sensor:
          name: Zone 5 - Temperature Sensor (Optional Override)
          description: Optional temperature sensor to override the climate entity's built-in sensor
          default: []
          selector:
            entity:
              domain: sensor
              device_class: temperature
              multiple: false

        zone5_valve:
          name: Zone 5 - Physical Valve Entity (REQUIRED if zone configured)
          description: >
            Physical valve switch that controls the actual heating valve.
            REQUIRED when zone is configured - must be specified along with Virtual Switch.
            The blueprint controls this physical valve directly for coordinated multi-zone heating.
          default: []
          selector:
            entity:
              multiple: false

        zone5_virtual_switch:
          name: Zone 5 - Virtual Switch (REQUIRED if zone configured)
          description: >
            Virtual/helper switch (input_boolean or switch helper) controlled by the Generic Thermostat.
            REQUIRED when zone is configured - must be specified along with Physical Valve Entity.
            Configure your Generic Thermostat to control this virtual switch instead of the physical valve.
            The blueprint monitors this switch to understand what the climate entity wants.
          default: []
          selector:
            entity:
              domain: 
                - switch
                - input_boolean
              multiple: false

    # ============================================================================
    # ZONES GROUP 2 (Zones 6-10) - COLLAPSIBLE
    # ============================================================================

    zones_group_2:
      name: "ðŸ  ZONES GROUP 2 (Zones 6-10)"
      icon: mdi:home-thermometer
      description: Configure heating zones 6 through 10. Each zone requires climate entity, physical valve, and virtual switch.
      collapsed: true
      input:
        # Zone 6 Configuration
        zone6_climate:
          name: Zone 6 - Climate Entity
          description: Climate entity for the sixth heating zone
          default: []
          selector:
            entity:
              domain: climate
              multiple: false

        zone6_temp_sensor:
          name: Zone 6 - Temperature Sensor (Optional Override)
          description: Optional temperature sensor to override the climate entity's built-in sensor
          default: []
          selector:
            entity:
              domain: sensor
              device_class: temperature
              multiple: false

        zone6_valve:
          name: Zone 6 - Physical Valve Entity (REQUIRED if zone configured)
          description: >
            Physical valve switch that controls the actual heating valve.
            REQUIRED when zone is configured - must be specified along with Virtual Switch.
            The blueprint controls this physical valve directly for coordinated multi-zone heating.
          default: []
          selector:
            entity:
              multiple: false

        zone6_virtual_switch:
          name: Zone 6 - Virtual Switch (REQUIRED if zone configured)
          description: >
            Virtual/helper switch (input_boolean or switch helper) controlled by the Generic Thermostat.
            REQUIRED when zone is configured - must be specified along with Physical Valve Entity.
            Configure your Generic Thermostat to control this virtual switch instead of the physical valve.
            The blueprint monitors this switch to understand what the climate entity wants.
          default: []
          selector:
            entity:
              domain:
                - switch
                - input_boolean
              multiple: false

        # Zone 7 Configuration
        zone7_climate:
          name: Zone 7 - Climate Entity
          description: Climate entity for the seventh heating zone
          default: []
          selector:
            entity:
              domain: climate
              multiple: false

        zone7_temp_sensor:
          name: Zone 7 - Temperature Sensor (Optional Override)
          description: Optional temperature sensor to override the climate entity's built-in sensor
          default: []
          selector:
            entity:
              domain: sensor
              device_class: temperature
              multiple: false

        zone7_valve:
          name: Zone 7 - Physical Valve Entity (REQUIRED if zone configured)
          description: >
            Physical valve switch that controls the actual heating valve.
            REQUIRED when zone is configured - must be specified along with Virtual Switch.
            The blueprint controls this physical valve directly for coordinated multi-zone heating.
          default: []
          selector:
            entity:
              multiple: false

        zone7_virtual_switch:
          name: Zone 7 - Virtual Switch (REQUIRED if zone configured)
          description: >
            Virtual/helper switch (input_boolean or switch helper) controlled by the Generic Thermostat.
            REQUIRED when zone is configured - must be specified along with Physical Valve Entity.
            Configure your Generic Thermostat to control this virtual switch instead of the physical valve.
            The blueprint monitors this switch to understand what the climate entity wants.
          default: []
          selector:
            entity:
              domain:
                - switch
                - input_boolean
              multiple: false

        # Zone 8 Configuration
        zone8_climate:
          name: Zone 8 - Climate Entity
          description: Climate entity for the eighth heating zone
          default: []
          selector:
            entity:
              domain: climate
              multiple: false

        zone8_temp_sensor:
          name: Zone 8 - Temperature Sensor (Optional Override)
          description: Optional temperature sensor to override the climate entity's built-in sensor
          default: []
          selector:
            entity:
              domain: sensor
              device_class: temperature
              multiple: false

        zone8_valve:
          name: Zone 8 - Physical Valve Entity (REQUIRED if zone configured)
          description: >
            Physical valve switch that controls the actual heating valve.
            REQUIRED when zone is configured - must be specified along with Virtual Switch.
            The blueprint controls this physical valve directly for coordinated multi-zone heating.
          default: []
          selector:
            entity:
              multiple: false

        zone8_virtual_switch:
          name: Zone 8 - Virtual Switch (REQUIRED if zone configured)
          description: >
            Virtual/helper switch (input_boolean or switch helper) controlled by the Generic Thermostat.
            REQUIRED when zone is configured - must be specified along with Physical Valve Entity.
            Configure your Generic Thermostat to control this virtual switch instead of the physical valve.
            The blueprint monitors this switch to understand what the climate entity wants.
          default: []
          selector:
            entity:
              domain:
                - switch
                - input_boolean
              multiple: false

        # Zone 9 Configuration
        zone9_climate:
          name: Zone 9 - Climate Entity
          description: Climate entity for the ninth heating zone
          default: []
          selector:
            entity:
              domain: climate
              multiple: false

        zone9_temp_sensor:
          name: Zone 9 - Temperature Sensor (Optional Override)
          description: Optional temperature sensor to override the climate entity's built-in sensor
          default: []
          selector:
            entity:
              domain: sensor
              device_class: temperature
              multiple: false

        zone9_valve:
          name: Zone 9 - Physical Valve Entity (REQUIRED if zone configured)
          description: >
            Physical valve switch that controls the actual heating valve.
            REQUIRED when zone is configured - must be specified along with Virtual Switch.
            The blueprint controls this physical valve directly for coordinated multi-zone heating.
          default: []
          selector:
            entity:
              multiple: false

        zone9_virtual_switch:
          name: Zone 9 - Virtual Switch (REQUIRED if zone configured)
          description: >
            Virtual/helper switch (input_boolean or switch helper) controlled by the Generic Thermostat.
            REQUIRED when zone is configured - must be specified along with Physical Valve Entity.
            Configure your Generic Thermostat to control this virtual switch instead of the physical valve.
            The blueprint monitors this switch to understand what the climate entity wants.
          default: []
          selector:
            entity:
              domain:
                - switch
                - input_boolean
              multiple: false

        # Zone 10 Configuration
        zone10_climate:
          name: Zone 10 - Climate Entity
          description: Climate entity for the tenth heating zone
          default: []
          selector:
            entity:
              domain: climate
              multiple: false

        zone10_temp_sensor:
          name: Zone 10 - Temperature Sensor (Optional Override)
          description: Optional temperature sensor to override the climate entity's built-in sensor
          default: []
          selector:
            entity:
              domain: sensor
              device_class: temperature
              multiple: false

        zone10_valve:
          name: Zone 10 - Physical Valve Entity (REQUIRED if zone configured)
          description: >
            Physical valve switch that controls the actual heating valve.
            REQUIRED when zone is configured - must be specified along with Virtual Switch.
            The blueprint controls this physical valve directly for coordinated multi-zone heating.
          default: []
          selector:
            entity:
              multiple: false

        zone10_virtual_switch:
          name: Zone 10 - Virtual Switch (REQUIRED if zone configured)
          description: >
            Virtual/helper switch (input_boolean or switch helper) controlled by the Generic Thermostat.
            REQUIRED when zone is configured - must be specified along with Physical Valve Entity.
            Configure your Generic Thermostat to control this virtual switch instead of the physical valve.
            The blueprint monitors this switch to understand what the climate entity wants.
          default: []
          selector:
            entity:
              domain:
                - switch
                - input_boolean
              multiple: false

    # ============================================================================
    # ZONES GROUP 3 (Zones 11-15) - COLLAPSIBLE
    # ============================================================================

    zones_group_3:
      name: "ðŸ  ZONES GROUP 3 (Zones 11-15)"
      icon: mdi:home-thermometer
      description: Configure heating zones 11 through 15. Each zone requires climate entity, physical valve, and virtual switch.
      collapsed: true
      input:
        # Zone 11 Configuration
        zone11_climate:
          name: Zone 11 - Climate Entity
          description: Climate entity for the eleventh heating zone
          default: []
          selector:
            entity:
              domain: climate
              multiple: false

        zone11_temp_sensor:
          name: Zone 11 - Temperature Sensor (Optional Override)
          description: Optional temperature sensor to override the climate entity's built-in sensor
          default: []
          selector:
            entity:
              domain: sensor
              device_class: temperature
              multiple: false

        zone11_valve:
          name: Zone 11 - Physical Valve Entity (REQUIRED if zone configured)
          description: >
            Physical valve switch that controls the actual heating valve.
            REQUIRED when zone is configured - must be specified along with Virtual Switch.
            The blueprint controls this physical valve directly for coordinated multi-zone heating.
          default: []
          selector:
            entity:
              multiple: false

        zone11_virtual_switch:
          name: Zone 11 - Virtual Switch (REQUIRED if zone configured)
          description: >
            Virtual/helper switch (input_boolean or switch helper) controlled by the Generic Thermostat.
            REQUIRED when zone is configured - must be specified along with Physical Valve Entity.
            Configure your Generic Thermostat to control this virtual switch instead of the physical valve.
            The blueprint monitors this switch to understand what the climate entity wants.
          default: []
          selector:
            entity:
              domain:
                - switch
                - input_boolean
              multiple: false

        # Zone 12 Configuration
        zone12_climate:
          name: Zone 12 - Climate Entity
          description: Climate entity for the twelfth heating zone
          default: []
          selector:
            entity:
              domain: climate
              multiple: false

        zone12_temp_sensor:
          name: Zone 12 - Temperature Sensor (Optional Override)
          description: Optional temperature sensor to override the climate entity's built-in sensor
          default: []
          selector:
            entity:
              domain: sensor
              device_class: temperature
              multiple: false

        zone12_valve:
          name: Zone 12 - Physical Valve Entity (REQUIRED if zone configured)
          description: >
            Physical valve switch that controls the actual heating valve.
            REQUIRED when zone is configured - must be specified along with Virtual Switch.
            The blueprint controls this physical valve directly for coordinated multi-zone heating.
          default: []
          selector:
            entity:
              multiple: false

        zone12_virtual_switch:
          name: Zone 12 - Virtual Switch (REQUIRED if zone configured)
          description: >
            Virtual/helper switch (input_boolean or switch helper) controlled by the Generic Thermostat.
            REQUIRED when zone is configured - must be specified along with Physical Valve Entity.
            Configure your Generic Thermostat to control this virtual switch instead of the physical valve.
            The blueprint monitors this switch to understand what the climate entity wants.
          default: []
          selector:
            entity:
              domain:
                - switch
                - input_boolean
              multiple: false

        # Zone 13 Configuration
        zone13_climate:
          name: Zone 13 - Climate Entity
          description: Climate entity for the thirteenth heating zone
          default: []
          selector:
            entity:
              domain: climate
              multiple: false

        zone13_temp_sensor:
          name: Zone 13 - Temperature Sensor (Optional Override)
          description: Optional temperature sensor to override the climate entity's built-in sensor
          default: []
          selector:
            entity:
              domain: sensor
              device_class: temperature
              multiple: false

        zone13_valve:
          name: Zone 13 - Physical Valve Entity (REQUIRED if zone configured)
          description: >
            Physical valve switch that controls the actual heating valve.
            REQUIRED when zone is configured - must be specified along with Virtual Switch.
            The blueprint controls this physical valve directly for coordinated multi-zone heating.
          default: []
          selector:
            entity:
              multiple: false

        zone13_virtual_switch:
          name: Zone 13 - Virtual Switch (REQUIRED if zone configured)
          description: >
            Virtual/helper switch (input_boolean or switch helper) controlled by the Generic Thermostat.
            REQUIRED when zone is configured - must be specified along with Physical Valve Entity.
            Configure your Generic Thermostat to control this virtual switch instead of the physical valve.
            The blueprint monitors this switch to understand what the climate entity wants.
          default: []
          selector:
            entity:
              domain:
                - switch
                - input_boolean
              multiple: false

        # Zone 14 Configuration
        zone14_climate:
          name: Zone 14 - Climate Entity
          description: Climate entity for the fourteenth heating zone
          default: []
          selector:
            entity:
              domain: climate
              multiple: false

        zone14_temp_sensor:
          name: Zone 14 - Temperature Sensor (Optional Override)
          description: Optional temperature sensor to override the climate entity's built-in sensor
          default: []
          selector:
            entity:
              domain: sensor
              device_class: temperature
              multiple: false

        zone14_valve:
          name: Zone 14 - Physical Valve Entity (REQUIRED if zone configured)
          description: >
            Physical valve switch that controls the actual heating valve.
            REQUIRED when zone is configured - must be specified along with Virtual Switch.
            The blueprint controls this physical valve directly for coordinated multi-zone heating.
          default: []
          selector:
            entity:
              multiple: false

        zone14_virtual_switch:
          name: Zone 14 - Virtual Switch (REQUIRED if zone configured)
          description: >
            Virtual/helper switch (input_boolean or switch helper) controlled by the Generic Thermostat.
            REQUIRED when zone is configured - must be specified along with Physical Valve Entity.
            Configure your Generic Thermostat to control this virtual switch instead of the physical valve.
            The blueprint monitors this switch to understand what the climate entity wants.
          default: []
          selector:
            entity:
              domain:
                - switch
                - input_boolean
              multiple: false

        # Zone 15 Configuration
        zone15_climate:
          name: Zone 15 - Climate Entity
          description: Climate entity for the fifteenth heating zone
          default: []
          selector:
            entity:
              domain: climate
              multiple: false

        zone15_temp_sensor:
          name: Zone 15 - Temperature Sensor (Optional Override)
          description: Optional temperature sensor to override the climate entity's built-in sensor
          default: []
          selector:
            entity:
              domain: sensor
              device_class: temperature
              multiple: false

        zone15_valve:
          name: Zone 15 - Physical Valve Entity (REQUIRED if zone configured)
          description: >
            Physical valve switch that controls the actual heating valve.
            REQUIRED when zone is configured - must be specified along with Virtual Switch.
            The blueprint controls this physical valve directly for coordinated multi-zone heating.
          default: []
          selector:
            entity:
              multiple: false

        zone15_virtual_switch:
          name: Zone 15 - Virtual Switch (REQUIRED if zone configured)
          description: >
            Virtual/helper switch (input_boolean or switch helper) controlled by the Generic Thermostat.
            REQUIRED when zone is configured - must be specified along with Physical Valve Entity.
            Configure your Generic Thermostat to control this virtual switch instead of the physical valve.
            The blueprint monitors this switch to understand what the climate entity wants.
          default: []
          selector:
            entity:
              domain:
                - switch
                - input_boolean
              multiple: false

    # Temperature Management Settings
    temp_difference_open:
      name: Temperature Difference to Open Valve
      description: >
        How many degrees below target temperature should trigger valve opening.
        For example, 0.5Â°C means the valve opens when current temp is 0.5Â°C or more below target.
      default: 0.5
      selector:
        number:
          min: 0.1
          max: 3.0
          step: 0.1
          unit_of_measurement: "Â°C"
          mode: slider

    temp_difference_close:
      name: Temperature Difference to Close Valve
      description: >
        How many degrees above target temperature should trigger valve closing.
        For example, 0.2Â°C means the valve closes when current temp is 0.2Â°C or more above target.
      default: 0.2
      selector:
        number:
          min: 0.0
          max: 2.0
          step: 0.1
          unit_of_measurement: "Â°C"
          mode: slider

    all_satisfied_temp_mode:
      name: All Zones Satisfied - Temperature Calculation Mode
      description: >
        When all zones are satisfied (at or above target), this determines the MAIN thermostat target.
        - 0% = Use lowest zone target temperature
        - 50% = Use average of all zone target temperatures
        - 100% = Use highest zone target temperature
      default: 50
      selector:
        number:
          min: 0
          max: 100
          step: 5
          unit_of_measurement: "%"
          mode: slider

    min_main_temp:
      name: Minimum MAIN Thermostat Temperature
      description: The minimum temperature the MAIN thermostat can be set to
      default: 18.0
      selector:
        number:
          min: 10.0
          max: 25.0
          step: 0.5
          unit_of_measurement: "Â°C"
          mode: slider

    max_main_temp:
      name: Maximum MAIN Thermostat Temperature
      description: The maximum temperature the MAIN thermostat can be set to
      default: 28.0
      selector:
        number:
          min: 20.0
          max: 35.0
          step: 0.5
          unit_of_measurement: "Â°C"
          mode: slider

    enable_cooling_mode:
      name: Enable Cooling Mode Support
      description: >
        Enable if your MAIN thermostat supports cooling. The logic will be inverted:
        valves open when temperature is above target (cooling needed).
      default: false
      selector:
        boolean:

    fallback_temp:
      name: Fallback Temperature
      description: >
        Temperature to use if a sensor fails or returns an invalid value.
        This prevents automation errors when sensors are unavailable.
      default: 20.0
      selector:
        number:
          min: 15.0
          max: 25.0
          step: 0.5
          unit_of_measurement: "Â°C"
          mode: slider

    valve_transition_delay:
      name: Valve Transition Delay
      description: >
        Time to wait (in seconds) after opening a new valve before closing the old valve.
        This ensures at least one valve is fully open during transitions. Set to 0 to disable.
        Recommended: 5-10 seconds for fast motorized valves, 60-120 seconds for slow valves.
      default: 5
      selector:
        number:
          min: 0
          max: 180
          step: 5
          unit_of_measurement: "seconds"
          mode: slider

    fallback_zones:
      name: Fallback Zone(s) - Always Keep Open
      description: >
        Select which zone(s) to keep open when all other zones are satisfied or overheated.
        This is critical to ensure at least one valve is always open for pump operation.
        If not specified, defaults to opening all zones when satisfied (current behavior).
        Recommended: Select corridor or least critical zone(s).
        You can select multiple zones for redundancy.
      default: []
      selector:
        entity:
          domain: climate
          multiple: true

    overheated_threshold:
      name: Overheated Threshold
      description: >
        How many degrees ABOVE target temperature indicates a zone is overheated.
        When all zones are overheated, only fallback zone(s) stay open and MAIN target is lowered.
        Default: 1.0Â°C means zone at 23Â°C with target 22Â°C is considered overheated.
      default: 1.0
      selector:
        number:
          min: 0.3
          max: 3.0
          step: 0.1
          unit_of_measurement: "Â°C"
          mode: slider

    trigger_time_interval:
      name: Trigger Time Interval
      description: >
        How often (in minutes) the automation should run periodic updates.
        This ensures regular recalculation even if no state changes are detected.
        Set to "Disabled" to rely only on state-change triggers (no periodic updates).
        Lower values provide more responsive control but may increase system load.
        Default: 1 minute. The automation will also trigger on any state changes of climate entities.
      default: "/1"
      selector:
        select:
          options:
            - label: "Disabled (state-change triggers only)"
              value: "disabled"
            - label: "Every 1 minute"
              value: "/1"
            - label: "Every 2 minutes"
              value: "/2"
            - label: "Every 5 minutes"
              value: "/5"
            - label: "Every 10 minutes"
              value: "/10"
            - label: "Every 15 minutes"
              value: "/15"
            - label: "Every 30 minutes"
              value: "/30"
          mode: dropdown

# Automation triggers
trigger:
  # Periodic trigger - single time_pattern that fires every minute
  # Filtering logic determines if execution should proceed based on user's interval setting
  - platform: time_pattern
    minutes: "/1"
    id: periodic_update
  
  # MAIN thermostat state change triggers
  - platform: state
    entity_id: !input main_thermostat
    id: main_climate_state_change
  
  - platform: state
    entity_id: !input main_thermostat
    attribute: hvac_mode
    id: main_climate_hvac_mode_change
  
  - platform: state
    entity_id: !input main_thermostat
    attribute: temperature
    id: main_climate_target_temp_change
  
  - platform: state
    entity_id: !input main_thermostat
    attribute: current_temperature
    id: main_climate_current_temp_change
  
  # Zone climate entity state change triggers
  # Note: Zone climate entities are optional (default to []). When not configured,
  # these state triggers simply won't fire - this is standard HA blueprint behavior.
  # Zone 1
  - platform: state
    entity_id: !input zone1_climate
    id: zone1_climate_state_change
  
  - platform: state
    entity_id: !input zone1_climate
    attribute: hvac_mode
    id: zone1_climate_hvac_mode_change
  
  - platform: state
    entity_id: !input zone1_climate
    attribute: temperature
    id: zone1_climate_target_temp_change
  
  - platform: state
    entity_id: !input zone1_climate
    attribute: current_temperature
    id: zone1_climate_current_temp_change
  
  # Zone 2
  - platform: state
    entity_id: !input zone2_climate
    id: zone2_climate_state_change
  
  - platform: state
    entity_id: !input zone2_climate
    attribute: hvac_mode
    id: zone2_climate_hvac_mode_change
  
  - platform: state
    entity_id: !input zone2_climate
    attribute: temperature
    id: zone2_climate_target_temp_change
  
  - platform: state
    entity_id: !input zone2_climate
    attribute: current_temperature
    id: zone2_climate_current_temp_change
  
  # Zone 3
  - platform: state
    entity_id: !input zone3_climate
    id: zone3_climate_state_change
  
  - platform: state
    entity_id: !input zone3_climate
    attribute: hvac_mode
    id: zone3_climate_hvac_mode_change
  
  - platform: state
    entity_id: !input zone3_climate
    attribute: temperature
    id: zone3_climate_target_temp_change
  
  - platform: state
    entity_id: !input zone3_climate
    attribute: current_temperature
    id: zone3_climate_current_temp_change
  
  # Zone 4
  - platform: state
    entity_id: !input zone4_climate
    id: zone4_climate_state_change
  
  - platform: state
    entity_id: !input zone4_climate
    attribute: hvac_mode
    id: zone4_climate_hvac_mode_change
  
  - platform: state
    entity_id: !input zone4_climate
    attribute: temperature
    id: zone4_climate_target_temp_change
  
  - platform: state
    entity_id: !input zone4_climate
    attribute: current_temperature
    id: zone4_climate_current_temp_change
  
  # Zone 5
  - platform: state
    entity_id: !input zone5_climate
    id: zone5_climate_state_change
  
  - platform: state
    entity_id: !input zone5_climate
    attribute: hvac_mode
    id: zone5_climate_hvac_mode_change
  
  - platform: state
    entity_id: !input zone5_climate
    attribute: temperature
    id: zone5_climate_target_temp_change
  
  - platform: state
    entity_id: !input zone5_climate
    attribute: current_temperature
    id: zone5_climate_current_temp_change
  
  # Zone 6
  - platform: state
    entity_id: !input zone6_climate
    id: zone6_climate_state_change
  
  - platform: state
    entity_id: !input zone6_climate
    attribute: hvac_mode
    id: zone6_climate_hvac_mode_change
  
  - platform: state
    entity_id: !input zone6_climate
    attribute: temperature
    id: zone6_climate_target_temp_change
  
  - platform: state
    entity_id: !input zone6_climate
    attribute: current_temperature
    id: zone6_climate_current_temp_change
  
  # Zone 7
  - platform: state
    entity_id: !input zone7_climate
    id: zone7_climate_state_change
  
  - platform: state
    entity_id: !input zone7_climate
    attribute: hvac_mode
    id: zone7_climate_hvac_mode_change
  
  - platform: state
    entity_id: !input zone7_climate
    attribute: temperature
    id: zone7_climate_target_temp_change
  
  - platform: state
    entity_id: !input zone7_climate
    attribute: current_temperature
    id: zone7_climate_current_temp_change
  
  # Zone 8
  - platform: state
    entity_id: !input zone8_climate
    id: zone8_climate_state_change
  
  - platform: state
    entity_id: !input zone8_climate
    attribute: hvac_mode
    id: zone8_climate_hvac_mode_change
  
  - platform: state
    entity_id: !input zone8_climate
    attribute: temperature
    id: zone8_climate_target_temp_change
  
  - platform: state
    entity_id: !input zone8_climate
    attribute: current_temperature
    id: zone8_climate_current_temp_change
  
  # Zone 9
  - platform: state
    entity_id: !input zone9_climate
    id: zone9_climate_state_change
  
  - platform: state
    entity_id: !input zone9_climate
    attribute: hvac_mode
    id: zone9_climate_hvac_mode_change
  
  - platform: state
    entity_id: !input zone9_climate
    attribute: temperature
    id: zone9_climate_target_temp_change
  
  - platform: state
    entity_id: !input zone9_climate
    attribute: current_temperature
    id: zone9_climate_current_temp_change
  
  # Zone 10
  - platform: state
    entity_id: !input zone10_climate
    id: zone10_climate_state_change
  
  - platform: state
    entity_id: !input zone10_climate
    attribute: hvac_mode
    id: zone10_climate_hvac_mode_change
  
  - platform: state
    entity_id: !input zone10_climate
    attribute: temperature
    id: zone10_climate_target_temp_change
  
  - platform: state
    entity_id: !input zone10_climate
    attribute: current_temperature
    id: zone10_climate_current_temp_change
  
  # Zone 11
  - platform: state
    entity_id: !input zone11_climate
    id: zone11_climate_state_change
  
  - platform: state
    entity_id: !input zone11_climate
    attribute: hvac_mode
    id: zone11_climate_hvac_mode_change
  
  - platform: state
    entity_id: !input zone11_climate
    attribute: temperature
    id: zone11_climate_target_temp_change
  
  - platform: state
    entity_id: !input zone11_climate
    attribute: current_temperature
    id: zone11_climate_current_temp_change
  
  # Zone 12
  - platform: state
    entity_id: !input zone12_climate
    id: zone12_climate_state_change
  
  - platform: state
    entity_id: !input zone12_climate
    attribute: hvac_mode
    id: zone12_climate_hvac_mode_change
  
  - platform: state
    entity_id: !input zone12_climate
    attribute: temperature
    id: zone12_climate_target_temp_change
  
  - platform: state
    entity_id: !input zone12_climate
    attribute: current_temperature
    id: zone12_climate_current_temp_change
  
  # Zone 13
  - platform: state
    entity_id: !input zone13_climate
    id: zone13_climate_state_change
  
  - platform: state
    entity_id: !input zone13_climate
    attribute: hvac_mode
    id: zone13_climate_hvac_mode_change
  
  - platform: state
    entity_id: !input zone13_climate
    attribute: temperature
    id: zone13_climate_target_temp_change
  
  - platform: state
    entity_id: !input zone13_climate
    attribute: current_temperature
    id: zone13_climate_current_temp_change
  
  # Zone 14
  - platform: state
    entity_id: !input zone14_climate
    id: zone14_climate_state_change
  
  - platform: state
    entity_id: !input zone14_climate
    attribute: hvac_mode
    id: zone14_climate_hvac_mode_change
  
  - platform: state
    entity_id: !input zone14_climate
    attribute: temperature
    id: zone14_climate_target_temp_change
  
  - platform: state
    entity_id: !input zone14_climate
    attribute: current_temperature
    id: zone14_climate_current_temp_change
  
  # Zone 15
  - platform: state
    entity_id: !input zone15_climate
    id: zone15_climate_state_change
  
  - platform: state
    entity_id: !input zone15_climate
    attribute: hvac_mode
    id: zone15_climate_hvac_mode_change
  
  - platform: state
    entity_id: !input zone15_climate
    attribute: temperature
    id: zone15_climate_target_temp_change
  
  - platform: state
    entity_id: !input zone15_climate
    attribute: current_temperature
    id: zone15_climate_current_temp_change

# Conditions
condition: []

# Actions
action:
  - variables:
      # Input configurations
      main_climate: !input main_thermostat
      main_sensor: !input main_temp_sensor
      enable_cooling: !input enable_cooling_mode
      temp_diff_open: !input temp_difference_open
      temp_diff_close: !input temp_difference_close
      all_satisfied_mode: !input all_satisfied_temp_mode
      min_temp: !input min_main_temp
      max_temp: !input max_main_temp
      fallback_temperature: !input fallback_temp
      valve_delay: !input valve_transition_delay
      fallback_zone_list: !input fallback_zones
      overheat_threshold: !input overheated_threshold
      trigger_interval: !input trigger_time_interval
      
      # Zone configurations
      zones:
        - climate: !input zone1_climate
          temp_sensor: !input zone1_temp_sensor
          valve: !input zone1_valve
          virtual_switch: !input zone1_virtual_switch
        - climate: !input zone2_climate
          temp_sensor: !input zone2_temp_sensor
          valve: !input zone2_valve
          virtual_switch: !input zone2_virtual_switch
        - climate: !input zone3_climate
          temp_sensor: !input zone3_temp_sensor
          valve: !input zone3_valve
          virtual_switch: !input zone3_virtual_switch
        - climate: !input zone4_climate
          temp_sensor: !input zone4_temp_sensor
          valve: !input zone4_valve
          virtual_switch: !input zone4_virtual_switch
        - climate: !input zone5_climate
          temp_sensor: !input zone5_temp_sensor
          valve: !input zone5_valve
          virtual_switch: !input zone5_virtual_switch
        - climate: !input zone6_climate
          temp_sensor: !input zone6_temp_sensor
          valve: !input zone6_valve
          virtual_switch: !input zone6_virtual_switch
        - climate: !input zone7_climate
          temp_sensor: !input zone7_temp_sensor
          valve: !input zone7_valve
          virtual_switch: !input zone7_virtual_switch
        - climate: !input zone8_climate
          temp_sensor: !input zone8_temp_sensor
          valve: !input zone8_valve
          virtual_switch: !input zone8_virtual_switch
        - climate: !input zone9_climate
          temp_sensor: !input zone9_temp_sensor
          valve: !input zone9_valve
          virtual_switch: !input zone9_virtual_switch
        - climate: !input zone10_climate
          temp_sensor: !input zone10_temp_sensor
          valve: !input zone10_valve
          virtual_switch: !input zone10_virtual_switch
        - climate: !input zone11_climate
          temp_sensor: !input zone11_temp_sensor
          valve: !input zone11_valve
          virtual_switch: !input zone11_virtual_switch
        - climate: !input zone12_climate
          temp_sensor: !input zone12_temp_sensor
          valve: !input zone12_valve
          virtual_switch: !input zone12_virtual_switch
        - climate: !input zone13_climate
          temp_sensor: !input zone13_temp_sensor
          valve: !input zone13_valve
          virtual_switch: !input zone13_virtual_switch
        - climate: !input zone14_climate
          temp_sensor: !input zone14_temp_sensor
          valve: !input zone14_valve
          virtual_switch: !input zone14_virtual_switch
        - climate: !input zone15_climate
          temp_sensor: !input zone15_temp_sensor
          valve: !input zone15_valve
          virtual_switch: !input zone15_virtual_switch
      
      # Filter out empty zones
      active_zones: >
        {{ zones | selectattr('climate', 'ne', []) | selectattr('climate', 'ne', '') | list }}
      
      # Validate zone configuration: valve and virtual_switch must both be specified or both be empty
      zone_config_validation: >
        {% set ns = namespace(errors=[]) %}
        {% for zone in active_zones %}
          {% set has_valve = zone.valve != '' and zone.valve != [] and zone.valve != none %}
          {% set has_virtual = zone.virtual_switch != '' and zone.virtual_switch != [] and zone.virtual_switch != none %}
          {% if has_valve != has_virtual %}
            {% set ns.errors = ns.errors + ['Zone ' + zone.climate + ': Physical valve and virtual switch must both be specified or both be empty'] %}
          {% endif %}
        {% endfor %}
        {{ ns.errors }}
      
      # Get MAIN thermostat mode (heating or cooling)
      main_hvac_mode: >
        {{ states(main_climate) }}
      
      is_cooling_mode: >
        {{ enable_cooling and main_hvac_mode in ['cool', 'cool_only'] }}
      
      # Get MAIN sensor temperature (if override is provided)
      main_current_temp: >
        {% if main_sensor not in [none, '', []] %}
          {{ states(main_sensor) | float(fallback_temperature) }}
        {% else %}
          {{ state_attr(main_climate, 'current_temperature') | float(fallback_temperature) }}
        {% endif %}
      
      # Calculate zone data: current temp, target temp, needs heating/cooling
      zone_data: >
        {% set ns = namespace(zones=[]) %}
        {% for zone in active_zones %}
          {% if zone.climate %}
            {% set climate_entity = zone.climate %}
            {# Check if climate entity is available #}
            {% set is_available = states(climate_entity) not in ['unavailable', 'unknown'] %}
            
            {# Get current temperature - use override sensor if provided, otherwise use climate entity's attribute #}
            {% if zone.temp_sensor and zone.temp_sensor != [] and zone.temp_sensor != '' %}
              {% set current_temp = states(zone.temp_sensor) | float(fallback_temperature) %}
            {% else %}
              {% set current_temp = state_attr(climate_entity, 'current_temperature') | float(fallback_temperature) %}
            {% endif %}
            {% set target_temp = state_attr(climate_entity, 'temperature') | float(fallback_temperature) %}
            {% set zone_mode = states(climate_entity) %}
            
            {# Check if virtual switch is configured and get its state #}
            {% if zone.virtual_switch and zone.virtual_switch != [] and zone.virtual_switch != '' %}
              {% set virtual_switch_on = is_state(zone.virtual_switch, 'on') %}
            {% else %}
              {% set virtual_switch_on = none %}
            {% endif %}
            
            {# Determine if zone needs heating/cooling based on temperature AND virtual switch #}
            {% if is_cooling_mode %}
              {# Cooling mode: open valve if temp is above target + threshold #}
              {% set temp_needs_action = current_temp > (target_temp + temp_diff_open) %}
              {% set satisfied = current_temp <= (target_temp - temp_diff_close) %}
              {# Over-cooled in cooling mode = zone is excessively cold (below target - overheat_threshold) #}
              {% set is_overheated = current_temp < (target_temp - overheat_threshold) %}
            {% else %}
              {# Heating mode: open valve if temp is below target - threshold #}
              {% set temp_needs_action = current_temp < (target_temp - temp_diff_open) %}
              {% set satisfied = current_temp >= (target_temp + temp_diff_close) %}
              {# Overheated in heating = zone is too hot (above target + overheat_threshold) #}
              {% set is_overheated = current_temp > (target_temp + overheat_threshold) %}
            {% endif %}
            
            {# Final decision: needs_action considers both temperature AND virtual switch state #}
            {# If virtual switch is configured, respect what the climate entity wants (virtual switch state) #}
            {# AND what the blueprint logic determines (temperature-based need) #}
            {% if virtual_switch_on is not none %}
              {# Virtual switch configured: zone needs action if BOTH virtual switch is on AND temp indicates need #}
              {% set needs_action = virtual_switch_on and temp_needs_action %}
            {% else %}
              {# No virtual switch: use only temperature-based logic #}
              {% set needs_action = temp_needs_action %}
            {% endif %}
            
            {% set ns.zones = ns.zones + [{
              'climate': climate_entity,
              'valve': zone.valve,
              'virtual_switch': zone.virtual_switch,
              'temp_sensor': zone.temp_sensor,
              'current_temp': current_temp,
              'target_temp': target_temp,
              'needs_action': needs_action,
              'virtual_switch_on': virtual_switch_on,
              'temp_needs_action': temp_needs_action,
              'satisfied': satisfied,
              'overheated': is_overheated,
              'mode': zone_mode,
              'temp_deficit': target_temp - current_temp,
              'is_available': is_available
            }] %}
          {% endif %}
        {% endfor %}
        {{ ns.zones }}
      
      # Calculate which zones need heating/cooling (valves should be open)
      # Filter out unavailable zones to prevent stale data from affecting decisions
      zones_needing_action: >
        {{ zone_data | selectattr('is_available', 'eq', true) | selectattr('needs_action', 'eq', true) | list }}
      
      # Track unavailable zones for safety monitoring
      unavailable_zones: >
        {{ zone_data | selectattr('is_available', 'eq', false) | list }}
      
      # Check if MAIN climate is available
      main_climate_available: >
        {{ states(main_climate) not in ['unavailable', 'unknown'] }}
      
      # Check if all zones are satisfied
      # Only consider available zones to avoid stale data
      all_zones_satisfied: >
        {% set available_zones = zone_data | selectattr('is_available', 'eq', true) | list %}
        {{ available_zones | selectattr('satisfied', 'eq', false) | list | length == 0 and available_zones | length > 0 }}
      
      # Check if all zones are overheated
      # Only consider available zones to avoid stale data
      all_zones_overheated: >
        {% set available_zones = zone_data | selectattr('is_available', 'eq', true) | list %}
        {{ available_zones | selectattr('overheated', 'eq', false) | list | length == 0 and available_zones | length > 0 }}
      
      # Get fallback zones (default to first zone if not specified)
      fallback_zones: >
        {% if fallback_zone_list and fallback_zone_list | length > 0 %}
          {{ fallback_zone_list }}
        {% elif zone_data | length > 0 %}
          {{ [zone_data[0].climate] }}
        {% else %}
          []
        {% endif %}
      
      # Calculate target temperature for MAIN thermostat
      calculated_main_target: >
        {% if all_zones_overheated %}
          {# All zones are overheated - lower MAIN target to minimum #}
          {# Only fallback zone(s) will be open to prevent pump issues #}
          {{ min_temp }}
        {% elif zones_needing_action | length > 0 %}
          {# At least one zone needs heating/cooling - use improved algorithm #}
          {% if is_cooling_mode %}
            {# Cooling mode: use lowest target (coldest setting needed) #}
            {% set base_target = zones_needing_action | map(attribute='target_temp') | min | float %}
            {# For cooling, if MAIN sensor is cooler than zones, we may need to compensate downward #}
            {% set max_deficit = zones_needing_action | map(attribute='temp_deficit') | max | float %}
            {% if main_current_temp < base_target %}
              {# MAIN is cooler than target zones, compensate by lowering target further #}
              {# In cooling mode, deficit is negative (target < current), so we use abs #}
              {{ (base_target - (max_deficit | abs * 0.5)) | round(1) }}
            {% else %}
              {{ base_target }}
            {% endif %}
          {% else %}
            {# Heating mode: use improved weighted algorithm #}
            {% set base_target = zones_needing_action | map(attribute='target_temp') | max | float %}
            {# Calculate maximum temperature deficit among zones needing heating #}
            {% set max_deficit = zones_needing_action | map(attribute='temp_deficit') | max | float %}
            {# Get minimum current temp among zones needing heating #}
            {% set min_zone_temp = zones_needing_action | map(attribute='current_temp') | min | float %}
            
            {# If MAIN sensor (corridor) is warmer than zones needing heat, add compensation #}
            {% if main_current_temp > base_target %}
              {# Corridor is warmer than target - need to heat water more to reach zones #}
              {# Add 50% of the max deficit as compensation #}
              {{ (base_target + (max_deficit * 0.5)) | round(1) }}
            {% elif main_current_temp > min_zone_temp + 1.0 %}
              {# Corridor is significantly warmer than coldest zone - add partial compensation #}
              {% set temp_gap = main_current_temp - min_zone_temp %}
              {{ (base_target + (temp_gap * 0.3)) | round(1) }}
            {% else %}
              {# No significant temperature difference, use base target #}
              {{ base_target }}
            {% endif %}
          {% endif %}
        {% elif all_zones_satisfied and zone_data | length > 0 %}
          {# All zones satisfied - calculate based on mode slider #}
          {% set all_targets = zone_data | map(attribute='target_temp') | list %}
          {% if all_targets | length > 0 %}
            {% set min_target = all_targets | min | float %}
            {% set max_target = all_targets | max | float %}
            {% set avg_target = (all_targets | sum / all_targets | length) | float %}
            
            {% if all_satisfied_mode <= 5 %}
              {{ min_target }}
            {% elif all_satisfied_mode >= 95 %}
              {{ max_target }}
            {% else %}
              {# Interpolate between min and max based on slider position #}
              {% set mode_percent = all_satisfied_mode / 100.0 %}
              {{ (min_target + (max_target - min_target) * mode_percent) | round(1) }}
            {% endif %}
          {% else %}
            {{ min_temp }}
          {% endif %}
        {% elif zone_data | length > 0 %}
          {# Default: use average of all zone targets #}
          {{ (zone_data | map(attribute='target_temp') | sum / zone_data | length) | float | round(1) }}
        {% else %}
          {# No zones configured, use minimum temperature #}
          {{ min_temp }}
        {% endif %}
      
      # Clamp to min/max limits
      final_main_target: >
        {{ [min_temp, [calculated_main_target, max_temp] | min] | max | round(1) }}
      
      # Determine which valves should be open
      # CRITICAL: At least one valve must always be open to prevent pump issues
      valves_to_open_initial: >
        {% if all_zones_overheated %}
          {# All zones overheated - close all EXCEPT fallback zone(s) to prevent overheating #}
          {{ fallback_zones }}
        {% elif all_zones_satisfied %}
          {# All zones satisfied but not overheated #}
          {% if fallback_zone_list and fallback_zone_list | length > 0 %}
            {# If fallback zones configured, open only those to prevent overheating #}
            {{ fallback_zones }}
          {% else %}
            {# No fallback configured, use legacy behavior: open all valves #}
            {{ zone_data | map(attribute='climate') | list }}
          {% endif %}
        {% elif zones_needing_action | length > 0 %}
          {# Open valves for zones that need heating/cooling #}
          {{ zones_needing_action | map(attribute='climate') | list }}
        {% else %}
          {# Fallback: open fallback zone(s) or at least the first zone's valve #}
          {{ fallback_zones }}
        {% endif %}
      
      # Safety override: Ensure at least one valve is ALWAYS open
      # This is critical for pump operation - even if all climate entities are unavailable
      valves_to_open: >
        {% set initial_valves = valves_to_open_initial %}
        {% if initial_valves | length == 0 %}
          {# No valves would be open - SAFETY OVERRIDE: open fallback zones #}
          {% if fallback_zones | length > 0 %}
            {{ fallback_zones }}
          {% elif zone_data | length > 0 %}
            {# If fallback_zones is empty, use first available zone as last resort #}
            {{ [zone_data[0].climate] }}
          {% else %}
            {# This should never happen due to zone validation, but handle gracefully #}
            []
          {% endif %}
        {% else %}
          {{ initial_valves }}
        {% endif %}
      
      valves_to_close: >
        {% set open_list = valves_to_open %}
        {{ zone_data | map(attribute='climate') | reject('in', open_list) | list }}

  # Check if periodic trigger should be ignored based on user's interval setting
  # Single time_pattern trigger fires every minute, filter based on interval
  - choose:
      - conditions:
          - condition: template
            value_template: >
              {% if trigger.id != 'periodic_update' %}
                {# Not a periodic trigger, continue #}
                false
              {% elif trigger_interval == 'disabled' %}
                {# Periodic updates disabled, stop #}
                true
              {% else %}
                {# Check if current minute matches the selected interval #}
                {% set current_minute = now().minute %}
                {% set interval_map = {
                  '/1': 1,
                  '/2': 2,
                  '/5': 5,
                  '/10': 10,
                  '/15': 15,
                  '/30': 30
                } %}
                {% set interval_minutes = interval_map.get(trigger_interval, 1) %}
                {# Stop if current minute is not a multiple of the interval #}
                {{ current_minute % interval_minutes != 0 }}
              {% endif %}
        sequence:
          - stop: "Periodic trigger filtered based on interval setting."
    default: []

  # Validate configuration - if invalid, log errors and stop execution
  # Check 1: At least one zone must be configured
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ active_zones | length == 0 }}"
        sequence:
          - service: logbook.log
            data:
              name: Floor Heating Valve Manager - Configuration Error
              message: >
                CONFIGURATION ERROR: No zones configured.
                At least one zone must be set up with a climate entity for the automation to work.
                Please configure at least one zone (zone 1-15) with a climate entity.
          - stop: "No zones configured. Stopping automation."
    default: []
  
  # Check 2: Zone configuration validity (valve and virtual_switch must match)
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ zone_config_validation | length > 0 }}"
        sequence:
          - service: logbook.log
            data:
              name: Floor Heating Valve Manager - Configuration Error
              message: >
                CONFIGURATION ERROR: {{ zone_config_validation | join('. ') }}.
                Each zone must have BOTH physical valve and virtual switch configured,
                or BOTH must be empty. Fix your blueprint configuration.
          - stop: "Invalid zone configuration detected. Stopping automation to prevent unsafe valve control."
    default: []

  # Check for unavailable climate entities and log warnings
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ unavailable_zones | length > 0 or not main_climate_available }}"
        sequence:
          - service: system_log.write
            data:
              level: warning
              logger: blueprints.floor_heating_valve_manager
              message: >-
                WARNING: Some climate entities are unavailable!
                {% if not main_climate_available -%}
                MAIN climate ({{ main_climate }}) is UNAVAILABLE.
                {% endif -%}
                {% if unavailable_zones | length > 0 -%}
                Unavailable zone climate entities: {{ unavailable_zones | map(attribute='climate') | list | join(', ') }}.
                {% endif -%}
                {% if valves_to_open_initial | length == 0 -%}
                Safety override ACTIVE: Ensuring at least one valve ({{ valves_to_open | join(', ') }}) remains open to prevent pump issues.
                {% else -%}
                Valves currently open: {{ valves_to_open | join(', ') }}.
                {% endif -%}
    default: []

  # Log the calculation for debugging
  - service: logbook.log
    data:
      name: Floor Heating Valve Manager
      message: >
        Recalculating valve states and MAIN temperature.
        Mode: {{ 'Cooling' if is_cooling_mode else 'Heating' }}.
        MAIN sensor temp: {{ main_current_temp }}Â°C.
        Zones needing action: {{ zones_needing_action | length }}.
        All satisfied: {{ all_zones_satisfied }}.
        All overheated: {{ all_zones_overheated }}.
        Valves to open: {{ valves_to_open | length }}.
        Target MAIN temp: {{ final_main_target }}Â°C.
        {% if unavailable_zones | length > 0 %}
        WARNING: {{ unavailable_zones | length }} zone(s) unavailable.
        {% endif %}

  # Set MAIN thermostat target temperature
  - service: climate.set_temperature
    target:
      entity_id: !input main_thermostat
    data:
      temperature: "{{ final_main_target }}"

  # PHASE 1: Open valves that need to be opened
  # This ensures new valves are opening before we close old ones
  - repeat:
      for_each: "{{ zone_data }}"
      sequence:
        - variables:
            zone: "{{ repeat.item }}"
            should_open: "{{ zone.climate in valves_to_open }}"
        
        - condition: template
          value_template: "{{ should_open }}"
        
        # Open valve (turn on climate or valve entity)
        - choose:
            # If manual valve override is set, turn it on directly
            - conditions:
                - condition: template
                  value_template: "{{ zone.valve != '' and zone.valve != [] }}"
              sequence:
                - service: homeassistant.turn_on
                  target:
                    entity_id: "{{ zone.valve }}"
          default:
            # WARNING: When no valve override is specified, the climate entity
            # will control the valve based on its own internal logic.
            # This may conflict with the blueprint's decisions!
            # RECOMMENDATION: Always use valve overrides to prevent conflicts.
            # 
            # Fallback behavior: Set climate to heating/cooling mode
            # The climate entity will then control the valve based on its own
            # temperature comparison, which may differ from the blueprint's logic
            - service: climate.set_hvac_mode
              target:
                entity_id: "{{ zone.climate }}"
              data:
                hvac_mode: "{{ 'cool' if is_cooling_mode else 'heat' }}"

  # Wait for valve transition delay (allows valves to fully open)
  - condition: template
    value_template: "{{ valve_delay > 0 }}"
  - delay:
      seconds: "{{ valve_delay }}"

  # PHASE 2: Close valves that need to be closed
  # Now that new valves are open, we can safely close old ones
  - repeat:
      for_each: "{{ zone_data }}"
      sequence:
        - variables:
            zone: "{{ repeat.item }}"
            should_close: "{{ zone.climate in valves_to_close }}"
        
        - condition: template
          value_template: "{{ should_close }}"
        
        # Close valve (turn off climate or valve entity)
        - choose:
            # If manual valve override is set, turn it off
            - conditions:
                - condition: template
                  value_template: "{{ zone.valve != '' and zone.valve != [] }}"
              sequence:
                - service: homeassistant.turn_off
                  target:
                    entity_id: "{{ zone.valve }}"
          default:
            # Otherwise, turn off climate entity (close valve)
            - service: climate.set_hvac_mode
              target:
                entity_id: "{{ zone.climate }}"
              data:
                hvac_mode: "off"

mode: single
max_exceeded: silent
