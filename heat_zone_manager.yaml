####################################################################################################
##### Floor Heating Valve Manager Blueprint by Chester929                                     #####
##### Repository: https://github.com/Chester929/ha_custom_heat_zone_manager                   #####
##### Blueprint for managing floor heating valves with MAIN thermostat                        #####
####################################################################################################
---
blueprint:
  name: Floor Heating Valve Manager
  description: >
    # Floor Heating Valve Manager - Complete Zone Control


    **Version**: v2.0.0


    This blueprint manages floor heating valves alongside a MAIN thermostat that controls HVAC water heating.
    It dynamically adjusts valve states and the MAIN thermostat target temperature based on individual zone demands.


    **Key Features:**

    - Manages multiple heating zones (rooms) with individual thermostats/valves

    - Ensures at least one valve is ALWAYS open (critical for water pump operation)

    - Dynamically calculates MAIN thermostat target temperature based on zone demands

    - Supports manual override for temperature sensors and valve entities

    - Configurable temperature thresholds and calculation methods

    - Supports both heating and cooling modes (inverse logic)


    **Use Case:**

    Your HVAC unit heats water based on outdoor and indoor temperature sensors. Individual rooms have
    thermostats that control valves. This blueprint coordinates valve states and MAIN thermostat temperature
    to efficiently heat zones while preventing all valves from closing simultaneously.


    **Documentation:**

    For detailed setup and usage instructions, visit the [GitHub repository](https://github.com/Chester929/ha_custom_heat_zone_manager).

  source_url: https://github.com/Chester929/ha_custom_heat_zone_manager/blob/main/heat_zone_manager.yaml
  domain: automation
  homeassistant:
    min_version: 2024.1.0

  input:
    # MAIN Thermostat Configuration
    main_thermostat:
      name: MAIN Thermostat (REQUIRED)
      description: >
        The primary climate entity that controls your HVAC water heating system.
        This thermostat will have its target temperature automatically adjusted based on zone demands.
      selector:
        entity:
          domain: climate
          multiple: false

    main_temp_sensor:
      name: MAIN Temperature Sensor (Optional Override)
      description: >
        Optional temperature sensor for the MAIN thermostat location (e.g., corridor).
        If provided, the blueprint will use this to calculate smarter MAIN target temperatures
        that compensate for the difference between corridor and zone temperatures.
        This improves heating effectiveness when the MAIN sensor location differs from zones.
      default: []
      selector:
        entity:
          domain: sensor
          device_class: temperature
          multiple: false

    # ============================================================================
    # ZONES GROUP 1 (Zones 1-5) - COLLAPSIBLE
    # ============================================================================

    zones_group_1:
      name: "ðŸ  ZONES GROUP 1 (Zones 1-5)"
      icon: mdi:home-thermometer
      description: Configure heating zones 1 through 5. Each zone requires climate entity, physical valve, and virtual switch.
      collapsed: true
      input:
        # Zone 1 Configuration
        zone1_climate:
          name: Zone 1 - Climate Entity
          description: Climate entity for the first heating zone (e.g., bedroom, bathroom)
          default: []
          selector:
            entity:
              domain: climate
              multiple: false

        zone1_temp_sensor:
          name: Zone 1 - Temperature Sensor (Optional Override)
          description: Optional temperature sensor to override the climate entity's built-in sensor
          default: []
          selector:
            entity:
              domain: sensor
              device_class: temperature
              multiple: false

        zone1_valve:
          name: Zone 1 - Physical Valve Entity (REQUIRED if zone configured)
          description: >
            Physical valve switch that controls the actual heating valve.
            REQUIRED when zone is configured - must be specified along with Virtual Switch.
            The blueprint controls this physical valve directly for coordinated multi-zone heating.
          default: []
          selector:
            entity:
              multiple: false

        zone1_virtual_switch:
          name: Zone 1 - Virtual Switch (REQUIRED if zone configured)
          description: >
            Virtual/helper switch (input_boolean or switch helper) controlled by the Generic Thermostat.
            REQUIRED when zone is configured - must be specified along with Physical Valve Entity.
            Configure your Generic Thermostat to control this virtual switch instead of the physical valve.
            The blueprint monitors this switch to understand what the climate entity wants.
          default: []
          selector:
            entity:
              domain:
                - switch
                - input_boolean
              multiple: false

        # Zone 2 Configuration
        zone2_climate:
          name: Zone 2 - Climate Entity
          description: Climate entity for the second heating zone
          default: []
          selector:
            entity:
              domain: climate
              multiple: false

        zone2_temp_sensor:
          name: Zone 2 - Temperature Sensor (Optional Override)
          description: Optional temperature sensor to override the climate entity's built-in sensor
          default: []
          selector:
            entity:
              domain: sensor
              device_class: temperature
              multiple: false

        zone2_valve:
          name: Zone 2 - Physical Valve Entity (REQUIRED if zone configured)
          description: >
            Physical valve switch that controls the actual heating valve.
            REQUIRED when zone is configured - must be specified along with Virtual Switch.
            The blueprint controls this physical valve directly for coordinated multi-zone heating.
          default: []
          selector:
            entity:
              multiple: false

        zone2_virtual_switch:
          name: Zone 2 - Virtual Switch (REQUIRED if zone configured)
          description: >
            Virtual/helper switch (input_boolean or switch helper) controlled by the Generic Thermostat.
            REQUIRED when zone is configured - must be specified along with Physical Valve Entity.
            Configure your Generic Thermostat to control this virtual switch instead of the physical valve.
            The blueprint monitors this switch to understand what the climate entity wants.
          default: []
          selector:
            entity:
              domain:
                - switch
                - input_boolean
              multiple: false

        # Zone 3 Configuration
        zone3_climate:
          name: Zone 3 - Climate Entity
          description: Climate entity for the third heating zone
          default: []
          selector:
            entity:
              domain: climate
              multiple: false

        zone3_temp_sensor:
          name: Zone 3 - Temperature Sensor (Optional Override)
          description: Optional temperature sensor to override the climate entity's built-in sensor
          default: []
          selector:
            entity:
              domain: sensor
              device_class: temperature
              multiple: false

        zone3_valve:
          name: Zone 3 - Physical Valve Entity (REQUIRED if zone configured)
          description: >
            Physical valve switch that controls the actual heating valve.
            REQUIRED when zone is configured - must be specified along with Virtual Switch.
            The blueprint controls this physical valve directly for coordinated multi-zone heating.
          default: []
          selector:
            entity:
              multiple: false

        zone3_virtual_switch:
          name: Zone 3 - Virtual Switch (REQUIRED if zone configured)
          description: >
            Virtual/helper switch (input_boolean or switch helper) controlled by the Generic Thermostat.
            REQUIRED when zone is configured - must be specified along with Physical Valve Entity.
            Configure your Generic Thermostat to control this virtual switch instead of the physical valve.
            The blueprint monitors this switch to understand what the climate entity wants.
          default: []
          selector:
            entity:
              domain:
                - switch
                - input_boolean
              multiple: false

        # Zone 4 Configuration
        zone4_climate:
          name: Zone 4 - Climate Entity
          description: Climate entity for the fourth heating zone
          default: []
          selector:
            entity:
              domain: climate
              multiple: false

        zone4_temp_sensor:
          name: Zone 4 - Temperature Sensor (Optional Override)
          description: Optional temperature sensor to override the climate entity's built-in sensor
          default: []
          selector:
            entity:
              domain: sensor
              device_class: temperature
              multiple: false

        zone4_valve:
          name: Zone 4 - Physical Valve Entity (REQUIRED if zone configured)
          description: >
            Physical valve switch that controls the actual heating valve.
            REQUIRED when zone is configured - must be specified along with Virtual Switch.
            The blueprint controls this physical valve directly for coordinated multi-zone heating.
          default: []
          selector:
            entity:
              multiple: false

        zone4_virtual_switch:
          name: Zone 4 - Virtual Switch (REQUIRED if zone configured)
          description: >
            Virtual/helper switch (input_boolean or switch helper) controlled by the Generic Thermostat.
            REQUIRED when zone is configured - must be specified along with Physical Valve Entity.
            Configure your Generic Thermostat to control this virtual switch instead of the physical valve.
            The blueprint monitors this switch to understand what the climate entity wants.
          default: []
          selector:
            entity:
              domain:
                - switch
                - input_boolean
              multiple: false

        # Zone 5 Configuration
        zone5_climate:
          name: Zone 5 - Climate Entity
          description: Climate entity for the fifth heating zone
          default: []
          selector:
            entity:
              domain: climate
              multiple: false

        zone5_temp_sensor:
          name: Zone 5 - Temperature Sensor (Optional Override)
          description: Optional temperature sensor to override the climate entity's built-in sensor
          default: []
          selector:
            entity:
              domain: sensor
              device_class: temperature
              multiple: false

        zone5_valve:
          name: Zone 5 - Physical Valve Entity (REQUIRED if zone configured)
          description: >
            Physical valve switch that controls the actual heating valve.
            REQUIRED when zone is configured - must be specified along with Virtual Switch.
            The blueprint controls this physical valve directly for coordinated multi-zone heating.
          default: []
          selector:
            entity:
              multiple: false

        zone5_virtual_switch:
          name: Zone 5 - Virtual Switch (REQUIRED if zone configured)
          description: >
            Virtual/helper switch (input_boolean or switch helper) controlled by the Generic Thermostat.
            REQUIRED when zone is configured - must be specified along with Physical Valve Entity.
            Configure your Generic Thermostat to control this virtual switch instead of the physical valve.
            The blueprint monitors this switch to understand what the climate entity wants.
          default: []
          selector:
            entity:
              domain:
                - switch
                - input_boolean
              multiple: false

    # ============================================================================
    # ZONES GROUP 2 (Zones 6-10) - COLLAPSIBLE
    # ============================================================================

    zones_group_2:
      name: "ðŸ  ZONES GROUP 2 (Zones 6-10)"
      icon: mdi:home-thermometer
      description: Configure heating zones 6 through 10. Each zone requires climate entity, physical valve, and virtual switch.
      collapsed: true
      input:
        # Zone 6 Configuration
        zone6_climate:
          name: Zone 6 - Climate Entity
          description: Climate entity for the sixth heating zone
          default: []
          selector:
            entity:
              domain: climate
              multiple: false

        zone6_temp_sensor:
          name: Zone 6 - Temperature Sensor (Optional Override)
          description: Optional temperature sensor to override the climate entity's built-in sensor
          default: []
          selector:
            entity:
              domain: sensor
              device_class: temperature
              multiple: false

        zone6_valve:
          name: Zone 6 - Physical Valve Entity (REQUIRED if zone configured)
          description: >
            Physical valve switch that controls the actual heating valve.
            REQUIRED when zone is configured - must be specified along with Virtual Switch.
            The blueprint controls this physical valve directly for coordinated multi-zone heating.
          default: []
          selector:
            entity:
              multiple: false

        zone6_virtual_switch:
          name: Zone 6 - Virtual Switch (REQUIRED if zone configured)
          description: >
            Virtual/helper switch (input_boolean or switch helper) controlled by the Generic Thermostat.
            REQUIRED when zone is configured - must be specified along with Physical Valve Entity.
            Configure your Generic Thermostat to control this virtual switch instead of the physical valve.
            The blueprint monitors this switch to understand what the climate entity wants.
          default: []
          selector:
            entity:
              domain:
                - switch
                - input_boolean
              multiple: false

        # Zone 7 Configuration
        zone7_climate:
          name: Zone 7 - Climate Entity
          description: Climate entity for the seventh heating zone
          default: []
          selector:
            entity:
              domain: climate
              multiple: false

        zone7_temp_sensor:
          name: Zone 7 - Temperature Sensor (Optional Override)
          description: Optional temperature sensor to override the climate entity's built-in sensor
          default: []
          selector:
            entity:
              domain: sensor
              device_class: temperature
              multiple: false

        zone7_valve:
          name: Zone 7 - Physical Valve Entity (REQUIRED if zone configured)
          description: >
            Physical valve switch that controls the actual heating valve.
            REQUIRED when zone is configured - must be specified along with Virtual Switch.
            The blueprint controls this physical valve directly for coordinated multi-zone heating.
          default: []
          selector:
            entity:
              multiple: false

        zone7_virtual_switch:
          name: Zone 7 - Virtual Switch (REQUIRED if zone configured)
          description: >
            Virtual/helper switch (input_boolean or switch helper) controlled by the Generic Thermostat.
            REQUIRED when zone is configured - must be specified along with Physical Valve Entity.
            Configure your Generic Thermostat to control this virtual switch instead of the physical valve.
            The blueprint monitors this switch to understand what the climate entity wants.
          default: []
          selector:
            entity:
              domain:
                - switch
                - input_boolean
              multiple: false

        # Zone 8 Configuration
        zone8_climate:
          name: Zone 8 - Climate Entity
          description: Climate entity for the eighth heating zone
          default: []
          selector:
            entity:
              domain: climate
              multiple: false

        zone8_temp_sensor:
          name: Zone 8 - Temperature Sensor (Optional Override)
          description: Optional temperature sensor to override the climate entity's built-in sensor
          default: []
          selector:
            entity:
              domain: sensor
              device_class: temperature
              multiple: false

        zone8_valve:
          name: Zone 8 - Physical Valve Entity (REQUIRED if zone configured)
          description: >
            Physical valve switch that controls the actual heating valve.
            REQUIRED when zone is configured - must be specified along with Virtual Switch.
            The blueprint controls this physical valve directly for coordinated multi-zone heating.
          default: []
          selector:
            entity:
              multiple: false

        zone8_virtual_switch:
          name: Zone 8 - Virtual Switch (REQUIRED if zone configured)
          description: >
            Virtual/helper switch (input_boolean or switch helper) controlled by the Generic Thermostat.
            REQUIRED when zone is configured - must be specified along with Physical Valve Entity.
            Configure your Generic Thermostat to control this virtual switch instead of the physical valve.
            The blueprint monitors this switch to understand what the climate entity wants.
          default: []
          selector:
            entity:
              domain:
                - switch
                - input_boolean
              multiple: false

        # Zone 9 Configuration
        zone9_climate:
          name: Zone 9 - Climate Entity
          description: Climate entity for the ninth heating zone
          default: []
          selector:
            entity:
              domain: climate
              multiple: false

        zone9_temp_sensor:
          name: Zone 9 - Temperature Sensor (Optional Override)
          description: Optional temperature sensor to override the climate entity's built-in sensor
          default: []
          selector:
            entity:
              domain: sensor
              device_class: temperature
              multiple: false

        zone9_valve:
          name: Zone 9 - Physical Valve Entity (REQUIRED if zone configured)
          description: >
            Physical valve switch that controls the actual heating valve.
            REQUIRED when zone is configured - must be specified along with Virtual Switch.
            The blueprint controls this physical valve directly for coordinated multi-zone heating.
          default: []
          selector:
            entity:
              multiple: false

        zone9_virtual_switch:
          name: Zone 9 - Virtual Switch (REQUIRED if zone configured)
          description: >
            Virtual/helper switch (input_boolean or switch helper) controlled by the Generic Thermostat.
            REQUIRED when zone is configured - must be specified along with Physical Valve Entity.
            Configure your Generic Thermostat to control this virtual switch instead of the physical valve.
            The blueprint monitors this switch to understand what the climate entity wants.
          default: []
          selector:
            entity:
              domain:
                - switch
                - input_boolean
              multiple: false

        # Zone 10 Configuration
        zone10_climate:
          name: Zone 10 - Climate Entity
          description: Climate entity for the tenth heating zone
          default: []
          selector:
            entity:
              domain: climate
              multiple: false

        zone10_temp_sensor:
          name: Zone 10 - Temperature Sensor (Optional Override)
          description: Optional temperature sensor to override the climate entity's built-in sensor
          default: []
          selector:
            entity:
              domain: sensor
              device_class: temperature
              multiple: false

        zone10_valve:
          name: Zone 10 - Physical Valve Entity (REQUIRED if zone configured)
          description: >
            Physical valve switch that controls the actual heating valve.
            REQUIRED when zone is configured - must be specified along with Virtual Switch.
            The blueprint controls this physical valve directly for coordinated multi-zone heating.
          default: []
          selector:
            entity:
              multiple: false

        zone10_virtual_switch:
          name: Zone 10 - Virtual Switch (REQUIRED if zone configured)
          description: >
            Virtual/helper switch (input_boolean or switch helper) controlled by the Generic Thermostat.
            REQUIRED when zone is configured - must be specified along with Physical Valve Entity.
            Configure your Generic Thermostat to control this virtual switch instead of the physical valve.
            The blueprint monitors this switch to understand what the climate entity wants.
          default: []
          selector:
            entity:
              domain:
                - switch
                - input_boolean
              multiple: false

    # ============================================================================
    # ZONES GROUP 3 (Zones 11-15) - COLLAPSIBLE
    # ============================================================================

    zones_group_3:
      name: "ðŸ  ZONES GROUP 3 (Zones 11-15)"
      icon: mdi:home-thermometer
      description: Configure heating zones 11 through 15. Each zone requires climate entity, physical valve, and virtual switch.
      collapsed: true
      input:
        # Zone 11 Configuration
        zone11_climate:
          name: Zone 11 - Climate Entity
          description: Climate entity for the eleventh heating zone
          default: []
          selector:
            entity:
              domain: climate
              multiple: false

        zone11_temp_sensor:
          name: Zone 11 - Temperature Sensor (Optional Override)
          description: Optional temperature sensor to override the climate entity's built-in sensor
          default: []
          selector:
            entity:
              domain: sensor
              device_class: temperature
              multiple: false

        zone11_valve:
          name: Zone 11 - Physical Valve Entity (REQUIRED if zone configured)
          description: >
            Physical valve switch that controls the actual heating valve.
            REQUIRED when zone is configured - must be specified along with Virtual Switch.
            The blueprint controls this physical valve directly for coordinated multi-zone heating.
          default: []
          selector:
            entity:
              multiple: false

        zone11_virtual_switch:
          name: Zone 11 - Virtual Switch (REQUIRED if zone configured)
          description: >
            Virtual/helper switch (input_boolean or switch helper) controlled by the Generic Thermostat.
            REQUIRED when zone is configured - must be specified along with Physical Valve Entity.
            Configure your Generic Thermostat to control this virtual switch instead of the physical valve.
            The blueprint monitors this switch to understand what the climate entity wants.
          default: []
          selector:
            entity:
              domain:
                - switch
                - input_boolean
              multiple: false

        # Zone 12 Configuration
        zone12_climate:
          name: Zone 12 - Climate Entity
          description: Climate entity for the twelfth heating zone
          default: []
          selector:
            entity:
              domain: climate
              multiple: false

        zone12_temp_sensor:
          name: Zone 12 - Temperature Sensor (Optional Override)
          description: Optional temperature sensor to override the climate entity's built-in sensor
          default: []
          selector:
            entity:
              domain: sensor
              device_class: temperature
              multiple: false

        zone12_valve:
          name: Zone 12 - Physical Valve Entity (REQUIRED if zone configured)
          description: >
            Physical valve switch that controls the actual heating valve.
            REQUIRED when zone is configured - must be specified along with Virtual Switch.
            The blueprint controls this physical valve directly for coordinated multi-zone heating.
          default: []
          selector:
            entity:
              multiple: false

        zone12_virtual_switch:
          name: Zone 12 - Virtual Switch (REQUIRED if zone configured)
          description: >
            Virtual/helper switch (input_boolean or switch helper) controlled by the Generic Thermostat.
            REQUIRED when zone is configured - must be specified along with Physical Valve Entity.
            Configure your Generic Thermostat to control this virtual switch instead of the physical valve.
            The blueprint monitors this switch to understand what the climate entity wants.
          default: []
          selector:
            entity:
              domain:
                - switch
                - input_boolean
              multiple: false

        # Zone 13 Configuration
        zone13_climate:
          name: Zone 13 - Climate Entity
          description: Climate entity for the thirteenth heating zone
          default: []
          selector:
            entity:
              domain: climate
              multiple: false

        zone13_temp_sensor:
          name: Zone 13 - Temperature Sensor (Optional Override)
          description: Optional temperature sensor to override the climate entity's built-in sensor
          default: []
          selector:
            entity:
              domain: sensor
              device_class: temperature
              multiple: false

        zone13_valve:
          name: Zone 13 - Physical Valve Entity (REQUIRED if zone configured)
          description: >
            Physical valve switch that controls the actual heating valve.
            REQUIRED when zone is configured - must be specified along with Virtual Switch.
            The blueprint controls this physical valve directly for coordinated multi-zone heating.
          default: []
          selector:
            entity:
              multiple: false

        zone13_virtual_switch:
          name: Zone 13 - Virtual Switch (REQUIRED if zone configured)
          description: >
            Virtual/helper switch (input_boolean or switch helper) controlled by the Generic Thermostat.
            REQUIRED when zone is configured - must be specified along with Physical Valve Entity.
            Configure your Generic Thermostat to control this virtual switch instead of the physical valve.
            The blueprint monitors this switch to understand what the climate entity wants.
          default: []
          selector:
            entity:
              domain:
                - switch
                - input_boolean
              multiple: false

        # Zone 14 Configuration
        zone14_climate:
          name: Zone 14 - Climate Entity
          description: Climate entity for the fourteenth heating zone
          default: []
          selector:
            entity:
              domain: climate
              multiple: false

        zone14_temp_sensor:
          name: Zone 14 - Temperature Sensor (Optional Override)
          description: Optional temperature sensor to override the climate entity's built-in sensor
          default: []
          selector:
            entity:
              domain: sensor
              device_class: temperature
              multiple: false

        zone14_valve:
          name: Zone 14 - Physical Valve Entity (REQUIRED if zone configured)
          description: >
            Physical valve switch that controls the actual heating valve.
            REQUIRED when zone is configured - must be specified along with Virtual Switch.
            The blueprint controls this physical valve directly for coordinated multi-zone heating.
          default: []
          selector:
            entity:
              multiple: false

        zone14_virtual_switch:
          name: Zone 14 - Virtual Switch (REQUIRED if zone configured)
          description: >
            Virtual/helper switch (input_boolean or switch helper) controlled by the Generic Thermostat.
            REQUIRED when zone is configured - must be specified along with Physical Valve Entity.
            Configure your Generic Thermostat to control this virtual switch instead of the physical valve.
            The blueprint monitors this switch to understand what the climate entity wants.
          default: []
          selector:
            entity:
              domain:
                - switch
                - input_boolean
              multiple: false

        # Zone 15 Configuration
        zone15_climate:
          name: Zone 15 - Climate Entity
          description: Climate entity for the fifteenth heating zone
          default: []
          selector:
            entity:
              domain: climate
              multiple: false

        zone15_temp_sensor:
          name: Zone 15 - Temperature Sensor (Optional Override)
          description: Optional temperature sensor to override the climate entity's built-in sensor
          default: []
          selector:
            entity:
              domain: sensor
              device_class: temperature
              multiple: false

        zone15_valve:
          name: Zone 15 - Physical Valve Entity (REQUIRED if zone configured)
          description: >
            Physical valve switch that controls the actual heating valve.
            REQUIRED when zone is configured - must be specified along with Virtual Switch.
            The blueprint controls this physical valve directly for coordinated multi-zone heating.
          default: []
          selector:
            entity:
              multiple: false

        zone15_virtual_switch:
          name: Zone 15 - Virtual Switch (REQUIRED if zone configured)
          description: >
            Virtual/helper switch (input_boolean or switch helper) controlled by the Generic Thermostat.
            REQUIRED when zone is configured - must be specified along with Physical Valve Entity.
            Configure your Generic Thermostat to control this virtual switch instead of the physical valve.
            The blueprint monitors this switch to understand what the climate entity wants.
          default: []
          selector:
            entity:
              domain:
                - switch
                - input_boolean
              multiple: false

    # Temperature Management Settings
    temp_difference_open:
      name: Temperature Difference to Open Valve
      description: >
        How many degrees below target temperature should trigger valve opening.
        For example, 0.5Â°C means the valve opens when current temp is 0.5Â°C or more below target.
      default: 0.5
      selector:
        number:
          min: 0.1
          max: 3.0
          step: 0.1
          unit_of_measurement: "Â°C"
          mode: slider

    temp_difference_close:
      name: Temperature Difference to Close Valve
      description: >
        How many degrees above target temperature should trigger valve closing.
        For example, 0.2Â°C means the valve closes when current temp is 0.2Â°C or more above target.
      default: 0.2
      selector:
        number:
          min: 0.0
          max: 2.0
          step: 0.1
          unit_of_measurement: "Â°C"
          mode: slider

    all_satisfied_temp_mode:
      name: All Zones Satisfied - Temperature Calculation Mode
      description: >
        When all zones are satisfied (at or above target), this determines the MAIN thermostat target.
        - 0% = Use lowest zone target temperature
        - 50% = Use average of all zone target temperatures
        - 100% = Use highest zone target temperature
      default: 50
      selector:
        number:
          min: 0
          max: 100
          step: 5
          unit_of_measurement: "%"
          mode: slider

    min_main_temp:
      name: Minimum MAIN Thermostat Temperature
      description: The minimum temperature the MAIN thermostat can be set to
      default: 18.0
      selector:
        number:
          min: 10.0
          max: 25.0
          step: 0.5
          unit_of_measurement: "Â°C"
          mode: slider

    max_main_temp:
      name: Maximum MAIN Thermostat Temperature
      description: The maximum temperature the MAIN thermostat can be set to
      default: 28.0
      selector:
        number:
          min: 20.0
          max: 35.0
          step: 0.5
          unit_of_measurement: "Â°C"
          mode: slider

    enable_cooling_mode:
      name: Enable Cooling Mode Support
      description: >
        Enable if your MAIN thermostat supports cooling. The logic will be inverted:
        valves open when temperature is above target (cooling needed).
      default: false
      selector:
        boolean:

    fallback_temp:
      name: Fallback Temperature
      description: >
        Temperature to use if a sensor fails or returns an invalid value.
        This prevents automation errors when sensors are unavailable.
      default: 20.0
      selector:
        number:
          min: 15.0
          max: 25.0
          step: 0.5
          unit_of_measurement: "Â°C"
          mode: slider

    valve_transition_delay:
      name: Valve Transition Delay
      description: >
        Time to wait (in seconds) after opening a new valve before closing the old valve.
        This ensures at least one valve is fully open during transitions. Set to 0 to disable.
        Recommended: 5-10 seconds for fast motorized valves, 60-120 seconds for slow valves.
      default: 5
      selector:
        number:
          min: 0
          max: 180
          step: 5
          unit_of_measurement: "seconds"
          mode: slider

    fallback_zones:
      name: Fallback Zone(s) - Always Keep Open
      description: >
        Select which zone(s) to keep open when all other zones are satisfied or overheated.
        This is critical to ensure at least one valve is always open for pump operation.
        If not specified, defaults to opening all zones when satisfied (current behavior).
        Recommended: Select corridor or least critical zone(s).
        You can select multiple zones for redundancy.
      default: []
      selector:
        entity:
          domain: climate
          multiple: true

    overheated_threshold:
      name: Overheated Threshold
      description: >
        How many degrees ABOVE target temperature indicates a zone is overheated.
        When all zones are overheated, only fallback zone(s) stay open and MAIN target is lowered.
        Default: 1.0Â°C means zone at 23Â°C with target 22Â°C is considered overheated.
      default: 1.0
      selector:
        number:
          min: 0.3
          max: 3.0
          step: 0.1
          unit_of_measurement: "Â°C"
          mode: slider



# Automation triggers
trigger:
  # Time-based trigger - same pattern as NSPanel blueprint
  # Runs every minute at the top of the minute
  - platform: time_pattern
    minutes: "/1"
    id: periodic_update

# Conditions
condition: []

# Actions
action:
  - variables:
      # Input configurations
      main_climate: !input main_thermostat
      main_sensor: !input main_temp_sensor
      enable_cooling: !input enable_cooling_mode
      temp_diff_open: !input temp_difference_open
      temp_diff_close: !input temp_difference_close
      all_satisfied_mode: !input all_satisfied_temp_mode
      min_temp: !input min_main_temp
      max_temp: !input max_main_temp
      fallback_temperature: !input fallback_temp
      valve_delay: !input valve_transition_delay
      fallback_zone_list: !input fallback_zones
      overheat_threshold: !input overheated_threshold

      # Zone configurations
      zones:
        - climate: !input zone1_climate
          temp_sensor: !input zone1_temp_sensor
          valve: !input zone1_valve
          virtual_switch: !input zone1_virtual_switch
        - climate: !input zone2_climate
          temp_sensor: !input zone2_temp_sensor
          valve: !input zone2_valve
          virtual_switch: !input zone2_virtual_switch
        - climate: !input zone3_climate
          temp_sensor: !input zone3_temp_sensor
          valve: !input zone3_valve
          virtual_switch: !input zone3_virtual_switch
        - climate: !input zone4_climate
          temp_sensor: !input zone4_temp_sensor
          valve: !input zone4_valve
          virtual_switch: !input zone4_virtual_switch
        - climate: !input zone5_climate
          temp_sensor: !input zone5_temp_sensor
          valve: !input zone5_valve
          virtual_switch: !input zone5_virtual_switch
        - climate: !input zone6_climate
          temp_sensor: !input zone6_temp_sensor
          valve: !input zone6_valve
          virtual_switch: !input zone6_virtual_switch
        - climate: !input zone7_climate
          temp_sensor: !input zone7_temp_sensor
          valve: !input zone7_valve
          virtual_switch: !input zone7_virtual_switch
        - climate: !input zone8_climate
          temp_sensor: !input zone8_temp_sensor
          valve: !input zone8_valve
          virtual_switch: !input zone8_virtual_switch
        - climate: !input zone9_climate
          temp_sensor: !input zone9_temp_sensor
          valve: !input zone9_valve
          virtual_switch: !input zone9_virtual_switch
        - climate: !input zone10_climate
          temp_sensor: !input zone10_temp_sensor
          valve: !input zone10_valve
          virtual_switch: !input zone10_virtual_switch
        - climate: !input zone11_climate
          temp_sensor: !input zone11_temp_sensor
          valve: !input zone11_valve
          virtual_switch: !input zone11_virtual_switch
        - climate: !input zone12_climate
          temp_sensor: !input zone12_temp_sensor
          valve: !input zone12_valve
          virtual_switch: !input zone12_virtual_switch
        - climate: !input zone13_climate
          temp_sensor: !input zone13_temp_sensor
          valve: !input zone13_valve
          virtual_switch: !input zone13_virtual_switch
        - climate: !input zone14_climate
          temp_sensor: !input zone14_temp_sensor
          valve: !input zone14_valve
          virtual_switch: !input zone14_virtual_switch
        - climate: !input zone15_climate
          temp_sensor: !input zone15_temp_sensor
          valve: !input zone15_valve
          virtual_switch: !input zone15_virtual_switch

      # Filter out empty zones
      active_zones: >
        {{ zones | selectattr('climate', 'ne', []) | selectattr('climate', 'ne', '') | list }}

      # Validate zone configuration: valve and virtual_switch must both be specified or both be empty
      zone_config_validation: >
        {% set ns = namespace(errors=[]) %}
        {% for zone in active_zones %}
          {% set has_valve = zone.valve != '' and zone.valve != [] and zone.valve != none %}
          {% set has_virtual = zone.virtual_switch != '' and zone.virtual_switch != [] and zone.virtual_switch != none %}
          {% if has_valve != has_virtual %}
            {% set ns.errors = ns.errors + ['Zone ' + zone.climate + ': Physical valve and virtual switch must both be specified or both be empty'] %}
          {% endif %}
        {% endfor %}
        {{ ns.errors }}

      # Get MAIN thermostat mode (heating or cooling)
      main_hvac_mode: >
        {{ states(main_climate) }}

      is_cooling_mode: >
        {{ enable_cooling and main_hvac_mode in ['cool', 'cool_only'] }}

      # Get MAIN sensor temperature (if override is provided)
      main_current_temp: >
        {% if main_sensor not in [none, '', []] %}
          {{ states(main_sensor) | float(fallback_temperature) }}
        {% else %}
          {{ state_attr(main_climate, 'current_temperature') | float(fallback_temperature) }}
        {% endif %}

      # Calculate zone data: current temp, target temp, needs heating/cooling
      # OPTIMIZED: Pre-calculate thresholds once, reduce state lookups
      zone_data: >
        {% set ns = namespace(zones=[]) %}
        {% for zone in active_zones %}
          {% if zone.climate %}
            {% set climate_entity = zone.climate %}
            {% set zone_state = states(climate_entity) %}
            {% set is_available = zone_state not in ['unavailable', 'unknown'] %}

            {% if is_available %}
              {# Get current temperature - use override sensor if provided #}
              {% set has_temp_sensor = zone.temp_sensor and zone.temp_sensor != [] and zone.temp_sensor != '' %}
              {% set current_temp = states(zone.temp_sensor) | float(fallback_temperature) if has_temp_sensor else state_attr(climate_entity, 'current_temperature') | float(fallback_temperature) %}
              {% set target_temp = state_attr(climate_entity, 'temperature') | float(fallback_temperature) %}
              
              {# Pre-calculate threshold comparisons #}
              {% set temp_diff = current_temp - target_temp %}
              {% set has_virtual = zone.virtual_switch and zone.virtual_switch != [] and zone.virtual_switch != '' %}
              {% set virtual_switch_on = is_state(zone.virtual_switch, 'on') if has_virtual else none %}

              {# Determine zone state based on mode - simplified conditionals #}
              {% if is_cooling_mode %}
                {% set temp_needs_action = temp_diff > temp_diff_open %}
                {% set satisfied = temp_diff <= -temp_diff_close %}
                {% set is_overheated = temp_diff < -overheat_threshold %}
              {% else %}
                {% set temp_needs_action = temp_diff < -temp_diff_open %}
                {% set satisfied = temp_diff >= temp_diff_close %}
                {% set is_overheated = temp_diff > overheat_threshold %}
              {% endif %}

              {% set needs_action = (virtual_switch_on and temp_needs_action) if virtual_switch_on is not none else temp_needs_action %}

              {% set ns.zones = ns.zones + [{
                'climate': climate_entity,
                'valve': zone.valve,
                'virtual_switch': zone.virtual_switch,
                'temp_sensor': zone.temp_sensor,
                'current_temp': current_temp,
                'target_temp': target_temp,
                'needs_action': needs_action,
                'virtual_switch_on': virtual_switch_on,
                'temp_needs_action': temp_needs_action,
                'satisfied': satisfied,
                'overheated': is_overheated,
                'mode': zone_state,
                'temp_deficit': target_temp - current_temp,
                'is_available': true
              }] %}
            {% else %}
              {# Zone unavailable - add minimal data #}
              {% set ns.zones = ns.zones + [{
                'climate': climate_entity,
                'valve': zone.valve,
                'virtual_switch': zone.virtual_switch,
                'temp_sensor': zone.temp_sensor,
                'current_temp': fallback_temperature,
                'target_temp': fallback_temperature,
                'needs_action': false,
                'virtual_switch_on': none,
                'temp_needs_action': false,
                'satisfied': false,
                'overheated': false,
                'mode': zone_state,
                'temp_deficit': 0,
                'is_available': false
              }] %}
            {% endif %}
          {% endif %}
        {% endfor %}
        {{ ns.zones }}

      # OPTIMIZED: Use single-pass filtering with cached data from zone_data
      # Available zones only (filter once and reuse)
      available_zones: >
        {{ zone_data | selectattr('is_available', 'eq', true) | list }}

      # Calculate which zones need heating/cooling (valves should be open)
      zones_needing_action: >
        {{ available_zones | selectattr('needs_action', 'eq', true) | list }}

      # Track unavailable zones for safety monitoring
      unavailable_zones: >
        {{ zone_data | selectattr('is_available', 'eq', false) | list }}

      # Check if MAIN climate is available (single state lookup)
      main_climate_available: >
        {{ states(main_climate) not in ['unavailable', 'unknown'] }}

      # OPTIMIZED: Check if all available zones are satisfied
      all_zones_satisfied: >
        {% set ns = namespace(satisfied_count=0) %}
        {% set available_count = available_zones | length %}
        {% for z in available_zones %}
          {% if z.satisfied %}
            {% set ns.satisfied_count = ns.satisfied_count + 1 %}
          {% endif %}
        {% endfor %}
        {{ ns.satisfied_count == available_count and available_count > 0 }}

      # OPTIMIZED: Check if all available zones are overheated
      all_zones_overheated: >
        {% set ns = namespace(overheated_count=0) %}
        {% set available_count = available_zones | length %}
        {% for z in available_zones %}
          {% if z.overheated %}
            {% set ns.overheated_count = ns.overheated_count + 1 %}
          {% endif %}
        {% endfor %}
        {{ ns.overheated_count == available_count and available_count > 0 }}

      # Get fallback zones (default to first zone if not specified)
      fallback_zones: >
        {% if fallback_zone_list and fallback_zone_list | length > 0 %}
          {{ fallback_zone_list }}
        {% elif zone_data | length > 0 %}
          {{ [zone_data[0].climate] }}
        {% else %}
          []
        {% endif %}

      # OPTIMIZED: Calculate target temperature for MAIN thermostat
      # Pre-calculate min/max/avg values in a single pass to avoid multiple map operations
      calculated_main_target: >
        {% if all_zones_overheated %}
          {{ min_temp }}
        {% elif zones_needing_action | length > 0 %}
          {# Calculate min/max in single loop instead of multiple map operations #}
          {% set ns = namespace(min_target=none, max_target=none, min_current=none, max_deficit=none) %}
          {% for z in zones_needing_action %}
            {% set ns.min_target = z.target_temp if (ns.min_target is none or z.target_temp < ns.min_target) else ns.min_target %}
            {% set ns.max_target = z.target_temp if (ns.max_target is none or z.target_temp > ns.max_target) else ns.max_target %}
            {% set ns.min_current = z.current_temp if (ns.min_current is none or z.current_temp < ns.min_current) else ns.min_current %}
            {% set ns.max_deficit = z.temp_deficit if (ns.max_deficit is none or z.temp_deficit > ns.max_deficit) else ns.max_deficit %}
          {% endfor %}
          {% if is_cooling_mode %}
            {% set base_target = ns.min_target %}
            {% if main_current_temp < base_target %}
              {{ (base_target - (ns.max_deficit | abs * 0.5)) | round(1) }}
            {% else %}
              {{ base_target }}
            {% endif %}
          {% else %}
            {% set base_target = ns.max_target %}
            {% if main_current_temp > base_target %}
              {{ (base_target + (ns.max_deficit * 0.5)) | round(1) }}
            {% elif main_current_temp > ns.min_current + 1.0 %}
              {% set temp_gap = main_current_temp - ns.min_current %}
              {{ (base_target + (temp_gap * 0.3)) | round(1) }}
            {% else %}
              {{ base_target }}
            {% endif %}
          {% endif %}
        {% elif all_zones_satisfied and available_zones | length > 0 %}
          {# All zones satisfied - calculate min/max in single loop #}
          {% set ns = namespace(min_target=none, max_target=none) %}
          {% for z in available_zones %}
            {% set ns.min_target = z.target_temp if (ns.min_target is none or z.target_temp < ns.min_target) else ns.min_target %}
            {% set ns.max_target = z.target_temp if (ns.max_target is none or z.target_temp > ns.max_target) else ns.max_target %}
          {% endfor %}
          {% if all_satisfied_mode <= 5 %}
            {{ ns.min_target }}
          {% elif all_satisfied_mode >= 95 %}
            {{ ns.max_target }}
          {% else %}
            {% set mode_percent = all_satisfied_mode / 100.0 %}
            {{ (ns.min_target + (ns.max_target - ns.min_target) * mode_percent) | round(1) }}
          {% endif %}
        {% elif zone_data | length > 0 %}
          {# Default: use average of all zone targets - single pass #}
          {% set ns = namespace(sum=0, count=0) %}
          {% for z in zone_data %}
            {% set ns.sum = ns.sum + z.target_temp %}
            {% set ns.count = ns.count + 1 %}
          {% endfor %}
          {{ (ns.sum / ns.count) | round(1) if ns.count > 0 else min_temp }}
        {% else %}
          {{ min_temp }}
        {% endif %}

      # Clamp to min/max limits
      final_main_target: >
        {% if calculated_main_target < min_temp %}
          {{ min_temp | round(1) }}
        {% elif calculated_main_target > max_temp %}
          {{ max_temp | round(1) }}
        {% else %}
          {{ calculated_main_target | round(1) }}
        {% endif %}

      # OPTIMIZED: Determine which valves should be open
      # CRITICAL: At least one valve must always be open to prevent pump issues
      valves_to_open_initial: >
        {% if all_zones_overheated %}
          {{ fallback_zones }}
        {% elif all_zones_satisfied %}
          {% if fallback_zone_list and fallback_zone_list | length > 0 %}
            {{ fallback_zones }}
          {% else %}
            {# Build list in single pass instead of map operation #}
            {% set ns = namespace(climates=[]) %}
            {% for z in zone_data %}
              {% set ns.climates = ns.climates + [z.climate] %}
            {% endfor %}
            {{ ns.climates }}
          {% endif %}
        {% elif zones_needing_action | length > 0 %}
          {# Build list in single pass #}
          {% set ns = namespace(climates=[]) %}
          {% for z in zones_needing_action %}
            {% set ns.climates = ns.climates + [z.climate] %}
          {% endfor %}
          {{ ns.climates }}
        {% else %}
          {{ fallback_zones }}
        {% endif %}

      # Safety override: Ensure at least one valve is ALWAYS open
      # This is critical for pump operation - even if all climate entities are unavailable
      valves_to_open: >
        {% set initial_valves = valves_to_open_initial %}
        {% if initial_valves | length == 0 %}
          {# No valves would be open - SAFETY OVERRIDE: open fallback zones #}
          {% if fallback_zones | length > 0 %}
            {{ fallback_zones }}
          {% elif zone_data | length > 0 %}
            {# If fallback_zones is empty, use first available zone as last resort #}
            {{ [zone_data[0].climate] }}
          {% else %}
            {# This should never happen due to zone validation, but handle gracefully #}
            []
          {% endif %}
        {% else %}
          {{ initial_valves }}
        {% endif %}

      # OPTIMIZED: Build close list by filtering instead of reject (more efficient)
      valves_to_close: >
        {% set open_list = valves_to_open %}
        {% set ns = namespace(close_list=[]) %}
        {% for z in zone_data %}
          {% if z.climate not in open_list %}
            {% set ns.close_list = ns.close_list + [z.climate] %}
          {% endif %}
        {% endfor %}
        {{ ns.close_list }}

      # Current MAIN thermostat target temperature for comparison
      current_main_target: >
        {{ state_attr(main_climate, 'temperature') | float(fallback_temperature) }}

      # Check if MAIN temperature needs to change (with 0.1Â°C tolerance to avoid micro-adjustments)
      main_temp_needs_change: >
        {{ (final_main_target - current_main_target) | abs > 0.1 }}

  # Validate configuration - if invalid, log errors and stop execution
  # Check 1: At least one zone must be configured
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ active_zones | length == 0 }}"
        sequence:
          - service: logbook.log
            data:
              name: Floor Heating Valve Manager - Configuration Error
              message: >
                CONFIGURATION ERROR: No zones configured.
                At least one zone must be set up with a climate entity for the automation to work.
                Please configure at least one zone (zone 1-15) with a climate entity.
          - stop: "No zones configured. Stopping automation."
    default: []

  # Check 2: Zone configuration validity (valve and virtual_switch must match)
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ zone_config_validation | length > 0 }}"
        sequence:
          - service: logbook.log
            data:
              name: Floor Heating Valve Manager - Configuration Error
              message: >
                CONFIGURATION ERROR: {{ zone_config_validation | join('. ') }}.
                Each zone must have BOTH physical valve and virtual switch configured,
                or BOTH must be empty. Fix your blueprint configuration.
          - stop: "Invalid zone configuration detected. Stopping automation to prevent unsafe valve control."
    default: []

  # Check for unavailable climate entities and log warnings
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ unavailable_zones | length > 0 or not main_climate_available }}"
        sequence:
          - service: system_log.write
            data:
              level: warning
              logger: blueprints.floor_heating_valve_manager
              message: >-
                WARNING: Some climate entities are unavailable!
                {% if not main_climate_available -%}
                MAIN climate ({{ main_climate }}) is UNAVAILABLE.
                {% endif -%}
                {% if unavailable_zones | length > 0 -%}
                Unavailable zone climate entities: {{ unavailable_zones | map(attribute='climate') | list | join(', ') }}.
                {% endif -%}
                {% if valves_to_open_initial | length == 0 -%}
                Safety override ACTIVE: Ensuring at least one valve ({{ valves_to_open | join(', ') }}) remains open to prevent pump issues.
                {% else -%}
                Valves currently open: {{ valves_to_open | join(', ') }}.
                {% endif -%}
    default: []

  # Log the calculation for debugging
  - service: logbook.log
    data:
      name: Floor Heating Valve Manager
      message: >
        Evaluating valve states and MAIN temperature.
        Mode: {{ 'Cooling' if is_cooling_mode else 'Heating' }}.
        MAIN sensor temp: {{ main_current_temp }}Â°C.
        Zones needing action: {{ zones_needing_action | length }}.
        All satisfied: {{ all_zones_satisfied }}.
        All overheated: {{ all_zones_overheated }}.
        Valves to open: {{ valves_to_open | length }}.
        Target MAIN temp: {{ final_main_target }}Â°C (current: {{ current_main_target }}Â°C, needs change: {{ main_temp_needs_change }}).
        {% if unavailable_zones | length > 0 %}
        WARNING: {{ unavailable_zones | length }} zone(s) unavailable.
        {% endif %}

  # Set MAIN thermostat target temperature (only if it needs to change)
  - condition: template
    value_template: "{{ main_temp_needs_change }}"
  - service: climate.set_temperature
    target:
      entity_id: !input main_thermostat
    data:
      temperature: "{{ final_main_target }}"

  # PHASE 1: Open valves that need to be opened
  # This ensures new valves are opening before we close old ones
  - repeat:
      for_each: "{{ zone_data }}"
      sequence:
        - variables:
            zone: "{{ repeat.item }}"
            should_open: "{{ zone.climate in valves_to_open }}"

        - condition: template
          value_template: "{{ should_open }}"

        # Check if valve/climate is already in the desired state (open)
        - variables:
            is_already_open: >
              {% if zone.valve and zone.valve != [] and zone.valve != '' %}
                {{ is_state(zone.valve, 'on') }}
              {% else %}
                {% set zone_state = states(zone.climate) %}
                {{ zone_state in ['heat', 'cool', 'heat_cool', 'auto'] }}
              {% endif %}

        # Only open if not already open
        - condition: template
          value_template: "{{ not is_already_open }}"

        # Open valve (turn on climate or valve entity)
        - choose:
            # If manual valve override is set, turn it on directly
            - conditions:
                - condition: template
                  value_template: "{{ zone.valve != '' and zone.valve != [] }}"
              sequence:
                - service: homeassistant.turn_on
                  target:
                    entity_id: "{{ zone.valve }}"
          default:
            # WARNING: When no valve override is specified, the climate entity
            # will control the valve based on its own internal logic.
            # This may conflict with the blueprint's decisions!
            # RECOMMENDATION: Always use valve overrides to prevent conflicts.
            #
            # Fallback behavior: Set climate to heating/cooling mode
            # The climate entity will then control the valve based on its own
            # temperature comparison, which may differ from the blueprint's logic
            - service: climate.set_hvac_mode
              target:
                entity_id: "{{ zone.climate }}"
              data:
                hvac_mode: "{{ 'cool' if is_cooling_mode else 'heat' }}"

  # Wait for valve transition delay (allows valves to fully open)
  - condition: template
    value_template: "{{ valve_delay > 0 }}"
  - delay:
      seconds: "{{ valve_delay }}"

  # PHASE 2: Close valves that need to be closed
  # Now that new valves are open, we can safely close old ones
  - repeat:
      for_each: "{{ zone_data }}"
      sequence:
        - variables:
            zone: "{{ repeat.item }}"
            should_close: "{{ zone.climate in valves_to_close }}"

        - condition: template
          value_template: "{{ should_close }}"

        # Check if valve/climate is already in the desired state (closed)
        - variables:
            is_already_closed: >
              {% if zone.valve and zone.valve != [] and zone.valve != '' %}
                {{ is_state(zone.valve, 'off') }}
              {% else %}
                {% set zone_state = states(zone.climate) %}
                {{ zone_state not in ['heat', 'cool', 'heat_cool', 'auto'] }}
              {% endif %}

        # Only close if not already closed
        - condition: template
          value_template: "{{ not is_already_closed }}"

        # Close valve (turn off climate or valve entity)
        - choose:
            # If manual valve override is set, turn it off
            - conditions:
                - condition: template
                  value_template: "{{ zone.valve != '' and zone.valve != [] }}"
              sequence:
                - service: homeassistant.turn_off
                  target:
                    entity_id: "{{ zone.valve }}"
          default:
            # Otherwise, turn off climate entity (close valve)
            - service: climate.set_hvac_mode
              target:
                entity_id: "{{ zone.climate }}"
              data:
                hvac_mode: "off"

mode: queued
max: 10
